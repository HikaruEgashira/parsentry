# セキュリティパターン

Vulnhuntrsが使用するパターンベースの脆弱性検出システムの概念について説明します。

## 概要

セキュリティパターンは、LLM解析の前段階で潜在的な脆弱性を効率的にフィルタリングする正規表現ベースのルールです。複数のプログラミング言語に対応し、データフロー解析と組み合わせて使用されます。

## パターンの分類

### Source（データソース）
外部データがアプリケーションに入るエントリーポイントを識別します。

- **Webフレームワーク**: HTTPリクエストハンドラー、フォームデータ処理
- **ファイルシステム**: ファイル読み取り、設定ファイル解析
- **ネットワーク**: API応答、外部サービス呼び出し
- **環境**: 環境変数、コマンドライン引数

### Sink（データシンク）
検証されていないデータが脆弱性を引き起こす可能性のある危険な操作を識別します。

- **コード実行**: `eval()`、動的コード実行、テンプレートインジェクション
- **コマンド実行**: シェル実行、プロセス生成
- **データベース**: SQLクエリ実行、NoSQL操作
- **ファイルシステム**: ファイル書き込み、パストラバーサル
- **ネットワーク**: 外部HTTPリクエスト、URL構築

### Validate（バリデーション）
データを適切にサニタイズ、検証、エスケープするセキュリティ制御を識別します。

- **入力検証**: スキーマ検証、型チェック
- **出力エンコーディング**: HTMLエスケープ、URLエンコーディング
- **サニタイゼーション**: XSS保護、パス正規化
- **認証・認可**: トークン検証、権限チェック

## データフロー解析との統合

パターンマッチングの結果に基づいて、適切なコンテキスト抽出を行います：

- **Sourceマッチ**: `find_references`を使用してデータの流れを追跡
- **Sinkマッチ**: `find_definitions`を使用してデータの起源を追跡
- **Validateマッチ**: データフロー内のセキュリティ制御を特定

## リスクスコアリング

各パターンには1-10のリスクスコアが付与されます：

- **1-3**: 低リスク（情報提供）
- **4-6**: 中リスク（コンテキスト依存）
- **7-9**: 高リスク（脆弱性の可能性が高い）
- **10**: クリティカル（ほぼ確実に脆弱）

## 解析パイプラインでの役割

1. **ファイルフィルタリング**: 閾値以下のファイルをスキップ
2. **優先度付け**: 高リスクファイルを優先的にLLM解析
3. **コンテキスト強化**: マッチした領域をLLMに提供
4. **脆弱性タイプのヒント**: パターンカテゴリに基づく分類

## パフォーマンス最適化

- **コンパイル時最適化**: 起動時にパターンをコンパイル
- **並列処理**: 複数ファイルの同時解析
- **早期終了**: 高信頼度マッチで処理を停止
- **キャッシュ**: コンパイル済みパターンの再利用

## 設定とカスタマイゼーション

パターンは`src/patterns.yml`で管理され、言語別に以下の構造で定義されます：

```yaml
<language>:
  sources:
    - pattern: "正規表現パターン"
      description: "説明"
  sinks:
    - pattern: "正規表現パターン"
      description: "説明"
  validate:
    - pattern: "正規表現パターン"
      description: "説明"
```

## 将来の拡張

- **セマンティック解析**: ASTベースのパターンマッチング
- **機械学習統合**: プロジェクト固有パターンの学習
- **インタラクティブチューニング**: ユーザーフィードバックによる改善
