# 解析パイプライン

Parsentry の解析は3つのフェーズで構成されます。

## フェーズ 1: パターンマッチング

ソースコードに対してセキュリティパターンを適用し、解析対象を絞り込みます。

### 目的

- 大規模コードベースから関連ファイルを効率的に抽出
- LLM 解析のコストと時間を最適化
- PAR 分類に基づくリスクスコアリング

### PAR パターン

各パターンは PAR のいずれかに分類されます：

| 分類 | 検出対象 | 例 |
|------|----------|-----|
| Principal | データ入力点 | リクエストハンドラ、ファイル読み取り |
| Action | 処理・検証 | サニタイズ関数、暗号化処理 |
| Resource | 出力・操作対象 | DB クエリ、コマンド実行 |

### リスクスコア

パターンマッチの結果にリスクスコア（1-10）を付与し、優先度を決定します。

## フェーズ 2: コンテキスト構築

マッチした箇所の周辺情報を収集し、LLM が正確に解析できるコンテキストを構築します。

### 収集する情報

- **コード構造**: 関数定義、変数宣言、制御フロー
- **データフロー**: 変数の定義元と使用先
- **依存関係**: インポート、関数呼び出しグラフ

### PAR に基づくコンテキスト収集

パターンの PAR 分類に応じて、適切な方向にコンテキストを拡張します：

- **Principal**: 前方追跡（データがどこに流れるか）
- **Action**: 双方向追跡（入力と出力の両方）
- **Resource**: 後方追跡（データがどこから来たか）

## フェーズ 3: LLM 解析

構築したコンテキストを LLM に渡し、脆弱性を検出・評価します。

### LLM の役割

- パターンマッチでは検出できない複雑な脆弱性の発見
- ビジネスロジックの欠陥の特定
- 悪用可能性の評価と PoC 生成
- 修復提案の作成

### 出力

LLM は構造化された形式で以下を出力します：

- 脆弱性の説明と分類
- 信頼度スコア
- 概念実証コード
- 該当コードの参照

## パイプラインの流れ

```
ソースコード
    ↓
[パターンマッチング] → リスクスコア付きファイルリスト
    ↓
[コンテキスト構築] → PAR 分類に基づく関連コード収集
    ↓
[LLM 解析] → 脆弱性レポート
```

各フェーズは独立しており、パターン定義やコンテキスト収集戦略を変更しても、パイプライン全体への影響を最小限に抑えられます。
