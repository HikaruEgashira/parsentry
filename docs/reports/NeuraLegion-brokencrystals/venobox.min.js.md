# PAR Security Analysis Report

![中高信頼度](https://img.shields.io/badge/信頼度-中高-orange) **信頼度スコア: 85**

## 脆弱性タイプ

- `XSS`

## PAR Policy Analysis

### Principals (データ源)

- **D.data("href") / D.attr("href")**: Untrusted
  - Context: DOM属性
  - Risk Factors: 外部入力, 改ざん可能
- **D.attr(titleattr)**: Untrusted
  - Context: DOM属性
  - Risk Factors: ユーザー提供文字列

### Actions (セキュリティ制御)

- **d.html()による文字列結合**: Missing
  - Function: ユーザー入力のHTMLエスケープ／サニタイズ
  - Weaknesses: HTMLインジェクション, サニタイズ欠如
  - Bypass Vectors: <script>タグ挿入, "属性終了後のインジェクション

### Resources (操作対象)

- **d.html()**: Medium
  - Operation: innerHTML書き込み
  - Protection: 

### Policy Violations

#### NO_UNSANITIZED_HTML: innerHTML等での未サニタイズ文字列埋め込みによるXSS

- **Path**: ue() → d.html('<div class="vbox-inline">'+e+'</div>')
- **Severity**: high
- **Confidence**: 0.85

#### NO_ATTRIBUTE_ESCAPING: 動的生成HTMLにおける属性値未エスケープ

- **Path**: シェアボタン生成部 Q[...] = '<a ... description='+y+'>'
- **Severity**: high
- **Confidence**: 0.85

## 詳細解析

本ライブラリでは、ユーザー提供の属性値（例：data-href、href、title属性）をバリデーションやサニタイズなしに`d.html(...)`へ直接埋め込んでおり、悪意あるスクリプトやHTMLをページ上に注入できるため、クロスサイトスクリプティング(XSS)のリスクがあります。特に`ue()`内の`d.html('<div class="vbox-inline">'+e+'</div>')`や、シェアリンク生成部で`'+y+'`をエスケープせずに埋め込む箇所が危険です。

## PoC（概念実証コード）

```text
<script>
// 概念実証: 悪意あるリンクを設置し、XSSを実行
$(function(){
  $('body').append(
    '<a class="vbox-item" data-vbtype="ajax" data-href="/victim" title="<img src=x onerror=alert(1) />">Click me</a>'
  );
  $('.vbox-item').venobox({});
});
</script>
```

## 修復ガイダンス

### HTML埋め込み部分(d.html等)

- **Required**: ユーザー入力を適切にエスケープ／サニタイズ
- **Guidance**: DOMPurifyなどのサニタイズライブラリを用いるか、jQuery.text()でテキスト挿入を行い、生HTMLの直接挿入を避けてください。
- **Priority**: high

## 解析ノート

ユーザー提供のdata-hrefやtitle属性を文字列連結でinnerHTMLに出力している箇所に注目。jQuery.ajaxの結果をd.htmlに直接埋め込み、属性値もエスケープせずにHTMLを生成しているため、XSSのリスクが高い。その他、iframe生成やimgタグ挿入も同様にサニタイズが行われておらず、属性インジェクションが可能なためpolicy_violationsを検出。

