# PAR Security Analysis Report

![中高信頼度](https://img.shields.io/badge/信頼度-中高-orange) **信頼度スコア: 80**

## 脆弱性タイプ

- `XSS`

## PAR Policy Analysis

### Principals (データ源)

- **ユーザー入力 (userInput)**: Untrusted
  - Context: フロントエンドのフォームや URL パラメータ
  - Risk Factors: 任意スクリプト埋め込み可能, クロスサイトバイディング
- **リモート JSONP レスポンス**: Untrusted
  - Context: $.ajax jsonp による外部 API
  - Risk Factors: リモートから任意コード取得, コールバック名偽装

### Actions (セキュリティ制御)

- **S.fn.html / $.append**: Insufficient
  - Function: DOM への直接 HTML 挿入
  - Weaknesses: 未サニタイズの innerHTML 更新, 動的スクリプト挿入
  - Bypass Vectors: HTML タグを埋め込む, <script>タグ挿入
- **$.ajax jsonp**: Insufficient
  - Function: 動的スクリプトロード
  - Weaknesses: JSONP コールバック検証欠如
  - Bypass Vectors: 任意関数名を callback に指定
- **S.globalEval / b()**: Missing
  - Function: 動的スクリプト実行
  - Weaknesses: globalEval による直接 eval
  - Bypass Vectors: 任意 JavaScript コード文字列

### Resources (操作対象)

- **DOM (element.innerHTML)**: High
  - Operation: HTML 挿入
  - Protection: なし
- **動的 script タグ**: Critical
  - Operation: スクリプト挿入/評価
  - Protection: CSP 依存

### Policy Violations

#### JQ-001: 信頼できない入力を直接 innerHTML や script タグに渡している

- **Path**: $.html(userInput) -> element.innerHTML
- **Severity**: high
- **Confidence**: 0.80

#### JQ-002: JSONP コールバック名を検証せずに動的に URL に埋め込んでいる

- **Path**: $.ajax({ dataType: 'jsonp', jsonpCallback: userProvided })
- **Severity**: medium
- **Confidence**: 0.80

#### JQ-003: globalEval で未検証文字列を eval 相当のコード実行している

- **Path**: S.globalEval(untrustedString)
- **Severity**: high
- **Confidence**: 0.90

## 詳細解析

この jQuery コードには、外部またはユーザー提供データをそのまま DOM に挿入したり、動的に <script> タグを生成・実行する機能が多数含まれています。主に以下の流れで XSS 脆弱性のリスクが存在します。

1. ユーザー入力（例：$.html(), $.append(), $.globalEval() など）を検証・サニタイズせずにそのまま innerHTML や script タグに渡す。
2. JSONP 実装では callback 名をそのまま URL パラメータに埋め込み、外部からスクリプトをロード・評価する。
3. globalEval() や $.ajax({ dataType: 'script' }) による動的コード実行が行われる。

これらのパスにおいて、信頼できない入力が十分な検証やエスケープなしにブラウザ上で実行されることで、XSS 攻撃に利用される恐れがあります。

## PoC（概念実証コード）

```text
// XSS の POC
var malicious = "<img src=x onerror=alert('XSS') />";
$("#target").html(malicious);

// JSONP callback インジェクションの例
$.ajax({
  url: "https://example.com/api?callback=" + "evilCallback",
  dataType: "jsonp"
});
function evilCallback(){ alert('JSONP XSS'); }

// globalEval を介した任意コード実行
$.globalEval("alert('Injected!')");
```

## 修復ガイダンス

### HTML 挿入 (.html / .append)

- **Required**: 入力値を徹底的にエスケープ／サニタイズ
- **Guidance**: ライブラリの html() ではなく text() を利用するか、DOMPurify 等でホワイトリストサニタイズを行う
- **Priority**: high

### JSONP 設定

- **Required**: コールバック名をホワイトリストで検証
- **Guidance**: 固定または事前許可済みのコールバック名のみ許可し、ユーザー入力を直接挿入しない
- **Priority**: medium

### globalEval

- **Required**: 動的コード実行の廃止または厳格な検証
- **Guidance**: 可能な限り eval/API 呼び出しを排除し、信頼済みソース以外は実行しない
- **Priority**: critical

## 解析ノート

jQuery は innerHTML や eval 相当の globalEval、JSONP による script ロード機能を持つ。ユーザーやリモートからの文字列を無検証でこれらに渡すと XSS につながる。コード中の html(), append(), globalEval(), jsonpCallback が主な危険箇所。必要に応じて text() や CSP、サニタイズライブラリを導入し、信頼できない入力は絶対に直接評価しない。

