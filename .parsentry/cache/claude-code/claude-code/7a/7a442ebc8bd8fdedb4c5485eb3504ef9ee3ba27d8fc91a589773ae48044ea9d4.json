{
  "version": "1.0.0",
  "agent": "claude-code",
  "model": "claude-code",
  "prompt_hash": "7a442ebc8bd8fdedb4c5485eb3504ef9ee3ba27d8fc91a589773ae48044ea9d4",
  "response": "{\"scratchpad\":\"分析対象: repo/modules/networking/main.tf のcidr_block = \\\"0.0.0.0/0\\\"パターン\\n\\n主要な脆弱性:\\n1. aws_route_table.public の route ブロック (line 57-60): cidr_block = \\\"0.0.0.0/0\\\" でIGWへのルートを定義\\n   - これにより、インターネット経由で任意のトラフィックがVPC内に到達可能\\n   - AWS security modulesでもこれに対応するセキュリティグループの脆弱性が複合的に存在\\n\\n2. セキュリティグループの脆弱性 (modules/security/main.tf):\\n   - app_server: HTTP(80), HTTPS(443), port 3000 全て \\\"0.0.0.0/0\\\" から許可\\n   - database: MySQL(3306) が \\\"0.0.0.0/0\\\" から許可 - CRITICAL\\n   - cache: Redis(6379) が \\\"0.0.0.0/0\\\" から許可 - CRITICAL\\n\\n3. IAM権限の過度な付与 (modules/security/main.tf):\\n   - IAM Role with assume_role_policy が Principal.AWS: \\\"*\\\" を許可\\n   - IAM Policy が Action: \\\"*\\\" と Resource: \\\"*\\\" を許可\\n\\n4. 認証情報の硬コーディング (main.tf line 20-21):\\n   - AWS access_key と secret_key を直接記載\\n\\nPAR分析:\\n- Principal: インターネットのどこからでもアクセス可能 (untrusted)\\n- Action: ネットワークルーティングとセキュリティグループ (insufficient controls)\\n- Resource: VPC内のDBサーバー、キャッシュサーバー、その他リソース (critical sensitivity)\\n\\n複合的な脆弱性により、外部攻撃者が以下を実行可能:\\n1. インターネット経由でVPCにアクセス\\n2. セキュリティグループで保護されていないサービス(DB, Redis等)に直接接続\\n3. 盗まれたまたは推測されたIAM認証情報で任意のAWSリソース操作\\n\\nATTACK VECTOR: T1190 (Exploit Public-Facing Application), T1021 (Remote Service Session Initiation)\",\"analysis\":\"Terraform設定における複数段階の重大なセキュリティ脆弱性が検出されました。\\n\\n**主要な問題:**\\n\\n1. **ネットワーク設計の欠陥 (CRITICAL)**\\n   - aws_route_table.publicで「0.0.0.0/0」CIDR全体がIGWにルーティング\\n   - パブリックサブネットがこのルートテーブルに関連付けられている\\n   - 結果: インターネット上の任意のホストがVPC内のリソースにアクセス可能\\n\\n2. **セキュリティグループの過度に広範な許可 (CRITICAL)**\\n   - HTTPSとアプリケーションポート(3000)が「0.0.0.0/0」から許可\\n   - 最も危険: MySQLデータベース(3306)が「0.0.0.0/0」から許可\\n   - Redis キャッシュ(6379)も「0.0.0.0/0」から許可\\n   - これにより、インターネット上の攻撃者がDBサーバーに直接SQLインジェクション攻撃を実行可能\\n\\n3. **IAM権限の過度な付与 (CRITICAL)**\\n   - IAM Roleのassume_role_policyでPrincipal.AWS: \\\"*\\\"を許可\\n   - これにより任意のAWSアカウントがロールを引き継げる可能性\\n   - IAM Policyで Action: \\\"*\\\" と Resource: \\\"*\\\" を許可\\n   - 設定された権限でAWSの全リソースを操作可能\\n\\n4. **認証情報の露出 (CRITICAL)**\\n   - AWS access_key と secret_key をTerraformコードに直接記載\\n   - バージョン管理システムに保存される可能性\\n   - 攻撃者が盗まれた認証情報を使用してAWSリソースを完全に制御可能\\n\\n**攻撃シナリオ:**\\n1. 攻撃者はインターネットからVPCのDBサーバーに接続\\n2. SQLインジェクションにより認証なしでDB内容を抽出\\n3. または盗まれたIAM認証情報でAWSコンソール/APIに完全アクセス\\n4. ランサムウェアやバックドアを展開可能\",\"poc\":\"# PoC 1: インターネットからのDB直接接続攻撃\\nnmap -p 3306 <public-subnet-eip>\\nmysql -h <database-endpoint> -u admin -p<password> -e 'SELECT * FROM sensitive_data;'\\n\\n# PoC 2: SQLインジェクション (セキュリティグループの制限がない場合)\\ncurl -X POST http://<app-server-ip>:3000/api/endpoint \\\\\\n  -d \\\"id=1' OR '1'='1\\\"\\n\\n# PoC 3: 盗まれたIAM認証情報でのAWS API操作\\naws s3 ls \\\\\\n  --access-key AKIAIOSFODNN7EXAMPLE \\\\\\n  --secret-access-key wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY\\n\\n# PoC 4: IAM Role Hijacking (assume_role_policyが\\\"*\\\"の場合)\\naws sts assume-role \\\\\\n  --role-arn arn:aws:iam::ACCOUNT:role/parsentry-app-role \\\\\\n  --role-session-name AttackerSession\",\"confidence_score\":100,\"vulnerability_types\":[\"AFO\",\"IDOR\"],\"par_analysis\":{\"principals\":[{\"identifier\":\"Internet/0.0.0.0/0 (aws_route_table.public route)\",\"trust_level\":\"untrusted\",\"source_context\":\"インターネット全体からVPC内リソースへのアクセス経路\",\"risk_factors\":[\"任意のIPアドレスからのアクセスが可能\",\"認証メカニズムが存在しない\",\"地理的制限がない\",\"レート制限がない\"]},{\"identifier\":\"AWS IAM Principal with assume_role_policy='*'\",\"trust_level\":\"untrusted\",\"source_context\":\"任意のAWSアカウントが app_role を引き継ぎ可能\",\"risk_factors\":[\"外部アカウントからのロール引き継ぎが可能\",\"認証制御がない\",\"Principal制限がない\"]},{\"identifier\":\"Hardcoded AWS Credentials in main.tf\",\"trust_level\":\"untrusted\",\"source_context\":\"アクセスキーがコード内に平文で保存\",\"risk_factors\":[\"バージョン管理システムに露出\",\"ログファイルに記録される可能性\",\"チームメンバー全員がアクセス可能\",\"Git履歴から容易に復旧可能\"]}],\"actions\":[{\"identifier\":\"Network Routing (aws_route_table.public cidr_block=\\\"0.0.0.0/0\\\")\",\"security_function\":\"信頼できるネットワークのみからのアクセスを制限すること\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"0.0.0.0/0 CIDR全体がインターネットゲートウェイにルーティング\",\"送信元IPアドレスの検証がない\",\"NACLによる追加制限がない\"],\"bypass_vectors\":[\"インターネットのどのIPからでも直接VPC内リソースにアクセス可能\",\"VPN接続不要\"]},{\"identifier\":\"Security Group Ingress Rules (0.0.0.0/0 for DB/Cache/App)\",\"security_function\":\"データベースとキャッシュへのアクセスを信頼できるアプリケーション層のみに制限\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"MySQLポート(3306)が0.0.0.0/0から許可\",\"Redisポート(6379)が0.0.0.0/0から許可\",\"アプリケーションポート(3000)が0.0.0.0/0から許可\",\"セキュリティグループ間の参照がない (app_sg -> database_sg のような制限)\"],\"bypass_vectors\":[\"ネットワークセグメンテーション完全に回避可能\",\"中間層(ロードバランサー等)のバイパス可能\",\"DBに直接SQLインジェクション攻撃が可能\"]},{\"identifier\":\"IAM AssumeRole Policy (Principal.AWS='*')\",\"security_function\":\"特定の信頼できるプリンシパルのみがロールを引き継げるように制限\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"assume_role_policyで任意のAWSアカウントを許可\",\"MFAチャレンジがない\",\"IP制限がない\",\"条件制限がない\"],\"bypass_vectors\":[\"任意のAWSアカウント(攻撃者が作成した新規アカウントも含む)がロール引き継ぎ可能\",\"一度引き継ぎたら一時認証情報を取得してアクセス可能\"]},{\"identifier\":\"IAM Policy (Action='*', Resource='*')\",\"security_function\":\"最小権限の原則に従い必要な権限のみを付与\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"ワイルドカードアクション全許可\",\"ワイルドカードリソース全許可\",\"サービスベースの制限がない\",\"条件制限がない\",\"Deny ポリシーがない\"],\"bypass_vectors\":[\"アタッチされたロールで全AWSサービスを操作可能\",\"EC2インスタンスのメタデータから認証情報を取得して全権限でAPI操作可能\"]},{\"identifier\":\"AWS Provider Credentials (hardcoded in main.tf)\",\"security_function\":\"認証情報をセキュアに管理し、コード内に埋め込まない\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"平文のアクセスキーと秘密キーをコード内に保存\",\"バージョン管理システムに履歴として残存\",\"環境変数や別の安全な仕組みを使用していない\",\"キーローテーション機構がない\",\"キー使用の監査ログがない\"],\"bypass_vectors\":[\"Git履歴をチェックアウトして認証情報を復旧可能\",\"リポジトリにアクセス可能な人物全員が認証情報を利用可能\",\"盗まれたコードからAWSへの完全なアクセスが可能\"]}],\"resources\":[{\"identifier\":\"AWS VPC (aws_vpc.main)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Network Infrastructure - VPC container\",\"protection_mechanisms\":[\"なし - ルートテーブルで全トラフィックがIGWにルーティングされている\"]},{\"identifier\":\"Database Server (aws_security_group.database on port 3306)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Data Access - MySQL database\",\"protection_mechanisms\":[\"セキュリティグループで0.0.0.0/0から許可(実質的に保護なし)\",\"アプリケーション層を経由せず直接接続可能\"]},{\"identifier\":\"Redis Cache (aws_security_group.cache on port 6379)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Data Access - In-memory cache\",\"protection_mechanisms\":[\"セキュリティグループで0.0.0.0/0から許可(実質的に保護なし)\",\"キャッシュ内の機密データ(セッションキー、一時トークン等)へのアクセス可能\"]},{\"identifier\":\"Application Server (port 3000 - aws_security_group.app_server)\",\"sensitivity_level\":\"high\",\"operation_type\":\"Web Application Access\",\"protection_mechanisms\":[\"アプリケーション自体のセキュリティに依存\",\"ネットワークレベルではアクセス制限なし\"]},{\"identifier\":\"IAM Role (aws_iam_role.app_role)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Authorization - Role assumption\",\"protection_mechanisms\":[\"なし - 任意のAWSプリンシパルが引き継ぎ可能\"]},{\"identifier\":\"IAM Policy (aws_iam_policy.app_policy with Action/Resource '*')\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Authorization - Permission attachment\",\"protection_mechanisms\":[\"なし - 全AWS権限を許可\"]}],\"policy_violations\":[{\"rule_id\":\"AFO-001-NetworkSegmentation\",\"rule_description\":\"信頼できないネットワーク(インターネット全体)からVPC内の重要リソースへの直接アクセスは禁止\",\"violation_path\":\"Internet (0.0.0.0/0) -> aws_route_table.public (cidr_block=0.0.0.0/0) -> aws_internet_gateway -> VPC -> Database/Cache/AppServer\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"AFO-002-DatabaseExposure\",\"rule_description\":\"データベースポート(3306)は、対応するアプリケーションセキュリティグループからのアクセスのみを許可すること\",\"violation_path\":\"Internet (0.0.0.0/0) -> aws_security_group.database (MySQL 3306 from 0.0.0.0/0) -> RDS/Database\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"AFO-003-CacheExposure\",\"rule_description\":\"キャッシュサービス(Redis 6379)は、対応するアプリケーションセキュリティグループからのアクセスのみを許可すること\",\"violation_path\":\"Internet (0.0.0.0/0) -> aws_security_group.cache (Redis 6379 from 0.0.0.0/0) -> Redis Cache\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"IDOR-001-IAMRoleAssumption\",\"rule_description\":\"IAM RoleのAssumeRoleポリシーは、認可されたプリンシパルのみを指定すること。ワイルドカード('*')は許可されない\",\"violation_path\":\"任意のAWSアカウント -> aws_iam_role.app_role (Principal.AWS='*') -> assume_role -> 一時認証情報取得 -> AWS全リソース操作\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"IDOR-002-IAMPolicyOverPermissioning\",\"rule_description\":\"IAM Policyは最小権限の原則に従い、必要なアクション・リソースのみを指定すること。ワイルドカード('*')は許可されない\",\"violation_path\":\"EC2インスタンス -> IAM Role -> aws_iam_policy.app_policy (Action/Resource='*') -> AWS全リソース操作\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SEC-001-CredentialExposure\",\"rule_description\":\"AWS認証情報(access_key, secret_key)をコード内に埋め込むことは禁止。環境変数またはIAM Roleを使用すること\",\"violation_path\":\"GitHub Repository -> main.tf (hardcoded credentials) -> 攻撃者による認証情報盗難 -> AWS全リソース操作\",\"severity\":\"critical\",\"confidence\":1.0}]},\"remediation_guidance\":{\"policy_enforcement\":[{\"component\":\"Network Routing - aws_route_table.public\",\"required_improvement\":\"ルートテーブルで0.0.0.0/0をインターネットゲートウェイにルーティングするのは標準設計だが、セキュリティグループで送信元を厳格に制限する必要がある\",\"specific_guidance\":\"1. セキュリティグループで0.0.0.0/0許可を削除\\n2. Network ACLで追加の送信元制限を実装(オプション)\\n3. パブリックサブネットに置くリソースを最小化(ロードバランサーのみ推奨)\\n4. アプリケーション層とDB層を明確に分離\",\"priority\":\"critical\"},{\"component\":\"Security Group - Database (port 3306)\",\"required_improvement\":\"MySQLポート(3306)をアプリケーションセキュリティグループからのアクセスのみに制限\",\"specific_guidance\":\"cidr_blocks = [\\\"0.0.0.0/0\\\"] を削除\\n置き換え: security_groups = [aws_security_group.app_server.id]\\nこれにより、app_sgからのアクセスのみを許可\",\"priority\":\"critical\"},{\"component\":\"Security Group - Cache (port 6379)\",\"required_improvement\":\"Redisポート(6379)をアプリケーションセキュリティグループからのアクセスのみに制限\",\"specific_guidance\":\"cidr_blocks = [\\\"0.0.0.0/0\\\"] を削除\\n置き換え: security_groups = [aws_security_group.app_server.id]\\nこれにより、app_sgからのアクセスのみを許可\",\"priority\":\"critical\"},{\"component\":\"Security Group - App Server (ports 80, 443, 3000)\",\"required_improvement\":\"HTTPSポート(443)をロードバランサーのセキュリティグループまたは信頼できるIPのみに制限\\nアプリケーションポート(3000)をロードバランサーのセキュリティグループからのみに制限\",\"specific_guidance\":\"1. ロードバランサー用のセキュリティグループを作成\\n2. HTTPSポート(443): ALB sg idのみを許可\\n3. ポート(3000): ALB sg idのみを許可\\n4. HTTP(80): 削除するか、HTTPSへのリダイレクトのみに制限\",\"priority\":\"critical\"},{\"component\":\"IAM Role - assume_role_policy\",\"required_improvement\":\"Principal.AWS = \\\"*\\\" を削除し、特定の信頼できるプリンシパルのみを指定\",\"specific_guidance\":\"例えばEC2インスタンスプロファイルのみが引き継ぎ可能にする場合:\\nPrincipal = { Service = \\\"ec2.amazonaws.com\\\" }\\nまたは特定のAWSアカウントのみ:\\nPrincipal = { AWS = \\\"arn:aws:iam::ACCOUNT_ID:root\\\" }\",\"priority\":\"critical\"},{\"component\":\"IAM Policy - app_policy\",\"required_improvement\":\"Action = \\\"*\\\", Resource = \\\"*\\\" を削除し、最小権限の原則に従う\",\"specific_guidance\":\"必要なアクションのみを列挙:\\n- ec2:DescribeInstances\\n- s3:GetObject, s3:PutObject (storage_bucket のみ)\\n- rds-db:connect (database endpoint のみ)\\n- elasticache:DescribeCacheClusters (cache のみ)\\n条件制限も追加:\\n- NotIpAddress: aws:SourceIp (VPC内のIPのみ)\\n- StringEquals: aws:RequestedRegion (特定リージョンのみ)\",\"priority\":\"critical\"},{\"component\":\"AWS Provider - Credentials\",\"required_improvement\":\"平文のaccess_key/secret_keyをコードから削除し、環境変数またはIAM Roleを使用\",\"specific_guidance\":\"オプション1: 環境変数\\nexport AWS_ACCESS_KEY_ID=\\\"\\\"\\nexport AWS_SECRET_ACCESS_KEY=\\\"\\\"\\n\\nオプション2: IAM Role (推奨)\\nEC2インスタンスに適切なIAM RoleをアタッチしてTerraform実行\\n\\nオプション3: AWS SSO\\naws sso login を使用して認証\\n\\nコード内からはアクセスキーを削除\",\"priority\":\"critical\"}]},\"file_path\":null,\"pattern_description\":null,\"matched_source_code\":null}",
  "metadata": {
    "created_at": "2025-12-30T17:26:47.614918Z",
    "last_accessed": "2025-12-30T17:26:47.614918Z",
    "access_count": 0,
    "prompt_size": 5663,
    "response_size": 16501
  }
}