{
  "version": "1.0.0",
  "agent": "claude-code",
  "model": "claude-code",
  "prompt_hash": "9e101aa3bb26118c49a099e12eb2f76abb21d02e157953e3b6b8db4930ff26e1",
  "response": "{\"scratchpad\":\"コード分析メモ:\\n1. JWT_SECRETが文字列でハードコードされている（api.js:30）\\n2. jwt.sign操作は/auth/loginエンドポイント（L61-65）で実装\\n3. jwt.verify操作は/auth/jwt-loginエンドポイント（L88）で実装\\n4. SQLインジェクション多数：/auth/login(L47), /users/search(L122,126,130), /documents/:id(L150), /logs/:user_id(L453), /comments/create(L469)\\n5. パストラバーサル：/file/read(L339-352), /documents/:id/content(L165-191)\\n6. RCE：/system/execute(L318-336)\\n7. SSRF：/ssrf/fetch(L194-209), /scraper/url(L211-230)\\n8. テンプレートインジェクション：/template/handlebars(L252-264), /template/ejs(L266-277)\\n9. プロトタイプポルーション：/config/merge(L280-291), /object/deep-merge(L293-315)\\n10. デシリアライゼーション：/deserialize/eval(L423-433)\\n11. IDOR：/user/:id(L96-113), /logs/:user_id(L449-462)\\n12. ストアドXSS：/comments/create(L465-481)\\n13. XXE：/xml/parse(L233-249)\\n14. YAML逆シリアライズ：/yaml/parse(L436-446)\\n15. ファイルアップロード：/file/upload(L366-385)\\nJWT関連の主要な問題：\\n- シークレットキーが弱い（'super_secret_js_key_123'）\\n- アルゴリズムがHS256で固定\\n- トークン検証時に認可チェックがない\",\"analysis\":\"このコードは複数の深刻なセキュリティ脆弱性を含みます。特にJWT操作に関しては以下の問題があります：\\n\\n【JWTに関連する脆弱性】\\n1. **弱いシークレットキー**：JWT_SECRETが'super_secret_js_key_123'という簡単な文字列でハードコードされている。ブルートフォース攻撃で容易に破られる可能性があります。\\n\\n2. **認可チェックの欠落**：jwt.verify()で検証後、トークンの役割や権限を確認せずに処理を続行。攻撃者が低権限ユーザーのトークンでも管理者操作が可能。\\n\\n3. **JWT署名時の入力検証不足**：user.id, user.username, user.roleを直接トークンペイロードに含めるが、入力値の妥当性チェックがない。\\n\\n4. **トークン有効期限がない**：jwt.sign()にexpiresIn等のオプションがないため、一度署名されたトークンは永遠に有効。\\n\\n【その他の重大な脆弱性】\\n1. **SQLインジェクション（CRITICAL）**：/auth/login(L47), /users/search(L122-126), /comments/create(L469)など複数箇所で文字列補間によるSQLクエリ構築。\\n\\n2. **リモートコード実行（CRITICAL）**：/system/execute(L318-336)でユーザー入力をexecSync()に直接渡す。\\n\\n3. **パストラバーサル（HIGH）**：/file/read(L339-352)でパス検証なしにfs.readFileSync()を実行。/../../etc/passwdなどで任意ファイル読み取り可能。\\n\\n4. **SSRF（HIGH）**：/ssrf/fetch(L194-209)でユーザー指定URLをaxios.get()で取得。内部ネットワーク/メタデータサーバーへのアクセス可能。\\n\\n5. **IDOR（HIGH）**：/user/:idや/logs/:user_idで認可チェックなし。任意ユーザーのデータにアクセス可能。\\n\\n6. **テンプレートインジェクション（HIGH）**：/template/handlebars, /template/ejsでユーザーテンプレートを直接コンパイル/レンダリング。\\n\\n7. **不安全なデシリアライゼーション（HIGH）**：/deserialize/evalでeval()使用。直接コード実行可能。\\n\\n8. **ストアドXSS（MEDIUM）**：/comments/createで入力を検証なしにDBに保存。\",\"poc\":\"【JWT破解とトークン生成のPoC】\\nconst jwt = require('jsonwebtoken');\\nconst fs = require('fs');\\n\\n// 弱いシークレットキーをブルートフォース\\nconst weakSecret = 'super_secret_js_key_123';\\n\\n// 既存トークンを検証\\nconst validToken = jwt.sign({\\n  user_id: 999,\\n  username: 'attacker',\\n  role: 'admin'  // 管理者権限を自分で設定\\n}, weakSecret, { algorithm: 'HS256' });\\n\\nconsole.log('Forged admin token:', validToken);\\n\\n// このトークンはサーバーで検証パスする\\n// curl -X POST http://target/api/auth/jwt-login \\\\\\n//   -H 'Content-Type: application/json' \\\\\\n//   -d '{\\\"token\\\": \\\"' + validToken + '\\\"}'\\n\\n【SQLインジェクション PoC】\\n// POST /api/auth/login\\n{\\n  \\\"username\\\": \\\"' OR '1'='1\\\",\\n  \\\"password\\\": \\\"' OR '1'='1\\\"\\n}\\n// 結果: SELECT * FROM users WHERE username = '' OR '1'='1' AND password = '' OR '1'='1'\\n// 最初のユーザー（admin）で認証成功\\n\\n【コマンドインジェクション PoC】\\n// POST /api/system/execute\\n{\\n  \\\"command\\\": \\\"ls\\\",\\n  \\\"args\\\": [\\\";\\\", \\\"cat\\\", \\\"/etc/passwd\\\"]\\n}\\n// 実行: ls ; cat /etc/passwd\\n\\n【パストラバーサル PoC】\\n// GET /api/file/read?path=../../../etc/passwd\\n// /etc/passwdの内容を読み取り\\n\\n【SSRF PoC】\\n// POST /api/ssrf/fetch\\n{\\n  \\\"url\\\": \\\"http://169.254.169.254/latest/meta-data/iam/security-credentials/\\\"\\n}\\n// AWS EC2メタデータサーバーへのアクセス\",\"confidence_score\":100,\"vulnerability_types\":[\"SQLi\",\"RCE\",\"SSRF\",\"LFI\",\"IDOR\",\"XSS\",\"JWT\"],\"par_analysis\":{\"principals\":[{\"identifier\":\"req.body.username, req.body.password\",\"trust_level\":\"untrusted\",\"source_context\":\"ユーザーからのHTTP POSTリクエスト（/auth/login）\",\"risk_factors\":[\"ユーザー入力の検証なし\",\"SQLインジェクション可能\",\"ログに平文パスワード出力（L49）\"]},{\"identifier\":\"req.body.token\",\"trust_level\":\"semi_trusted\",\"source_context\":\"ユーザーからのHTTP POSTリクエスト（/auth/jwt-login）\",\"risk_factors\":[\"弱いシークレットキーで署名（L30）\",\"署名後の追加検証なし\",\"有効期限がない\"]},{\"identifier\":\"req.params.id, req.params.user_id\",\"trust_level\":\"untrusted\",\"source_context\":\"URL パラメータ（/user/:id, /logs/:user_id）\",\"risk_factors\":[\"SQLインジェクション可能（文字列補間）\",\"認可チェックなし（IDOR）\"]},{\"identifier\":\"req.query.q, req.query.role, req.query.limit\",\"trust_level\":\"untrusted\",\"source_context\":\"クエリパラメータ（/users/search）\",\"risk_factors\":[\"SQLインジェクション（L122, L126, L130）\",\"LIMIT値で整数オーバーフロー可能\"]},{\"identifier\":\"req.body.command, req.body.args\",\"trust_level\":\"untrusted\",\"source_context\":\"ユーザーからのHTTP POSTリクエスト（/system/execute）\",\"risk_factors\":[\"コマンドインジェクション（シェルメタキャラクタ未エスケープ）\",\"RCE直結\"]},{\"identifier\":\"req.query.path, req.query.dir\",\"trust_level\":\"untrusted\",\"source_context\":\"クエリパラメータ（/file/read, /file/list）\",\"risk_factors\":[\"パストラバーサル（../ 未検証）\",\"任意ファイル読み取り可能\"]},{\"identifier\":\"req.body.url\",\"trust_level\":\"untrusted\",\"source_context\":\"ユーザーからのHTTP POSTリクエスト（/ssrf/fetch, /scraper/url）\",\"risk_factors\":[\"SSRF（内部ネットワーク/メタデータサーバーアクセス可能）\",\"URL スキーム制限なし\"]},{\"identifier\":\"req.body.template, req.body.context\",\"trust_level\":\"untrusted\",\"source_context\":\"ユーザーからのHTTP POSTリクエスト（/template/handlebars, /template/ejs）\",\"risk_factors\":[\"テンプレートインジェクション\",\"コード実行可能\"]},{\"identifier\":\"req.body.content, req.body.author\",\"trust_level\":\"untrusted\",\"source_context\":\"ユーザーからのHTTP POSTリクエスト（/comments/create）\",\"risk_factors\":[\"SQLインジェクション（L469）\",\"ストアドXSS（エスケープなし）\"]},{\"identifier\":\"req.body.serialized\",\"trust_level\":\"untrusted\",\"source_context\":\"ユーザーからのHTTP POSTリクエスト（/deserialize/eval）\",\"risk_factors\":[\"eval()による直接コード実行\",\"任意コード実行可能\"]},{\"identifier\":\"req.body (YAML形式)\",\"trust_level\":\"untrusted\",\"source_context\":\"ユーザーからのHTTP POSTリクエスト（/yaml/parse）\",\"risk_factors\":[\"YAML デシリアライゼーション攻撃（yaml.load）\",\"オブジェクトコンストラクタ経由のRCE可能\"]}],\"actions\":[{\"identifier\":\"jwt.sign() (L61-65)\",\"security_function\":\"認証ユーザーのJWTトークンを生成\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"シークレットキーが弱い（'super_secret_js_key_123'）\",\"expiresIn等の有効期限設定なし\",\"トークンペイロードに入力検証なし\",\"署名後の検証がない\"],\"bypass_vectors\":[\"ブルートフォース（弱いシークレット）\",\"ペイロード改ざん（有効期限なし）\",\"管理者権限自作（role: 'admin'）\"]},{\"identifier\":\"jwt.verify() (L88)\",\"security_function\":\"JWTトークンの署名検証\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"署名検証後の認可チェックなし\",\"トークンの役割確認なし\",\"ブラックリスト/失効リストなし\",\"検証例外のエラーハンドリング不十分\"],\"bypass_vectors\":[\"検証済みトークンで認可チェック回避\",\"低権限トークンで管理者操作実行\"]},{\"identifier\":\"db.get(query) (L51-57, L102-105, 他複数)\",\"security_function\":\"SQLクエリの実行\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"パラメータ化クエリなし（文字列補間）\",\"SQLインジェクション対策なし\"],\"bypass_vectors\":[\"UNION SELECT攻撃\",\"時間ベースのブラインドSQLi\",\"エラーベースのSQLi（エラーメッセージ出力）\"]},{\"identifier\":\"fs.readFileSync() (L179, L344)\",\"security_function\":\"ファイル読み取り\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"パストラバーサル対策なし\",\"ホワイトリスト検証なし\",\"相対パス許可\"],\"bypass_vectors\":[\"../../../etc/passwd\",\"シンボリックリンク経由のアクセス\"]},{\"identifier\":\"execSync() (L324)\",\"security_function\":\"システムコマンド実行\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"シェルメタキャラクタのエスケープなし\",\"args配列のjoin時にシェル解釈される\"],\"bypass_vectors\":[\"セミコロン(;)でコマンド連結\",\"パイプ(|)でコマンド結合\",\"バッククォート(`)でサブシェル実行\"]},{\"identifier\":\"axios.get(url) (L199, L216)\",\"security_function\":\"外部URLからコンテンツ取得\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"URLスキーム制限なし\",\"内部ネットワーク/ローカルホストアクセス可能\",\"DNS rebinding対策なし\"],\"bypass_vectors\":[\"http://169.254.169.254 (AWS メタデータ)\",\"http://127.0.0.1:8080 (内部サービス)\",\"file:// プロトコル（ライブラリによっては）\"]},{\"identifier\":\"handlebars.compile() (L257)\",\"security_function\":\"Handlebarsテンプレートのコンパイル\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"ユーザー入力テンプレート直接受け取り\",\"サンドボックス化なし\",\"式の制限なし\"],\"bypass_vectors\":[\"{{#each}} でループ\",\"{{#if}} で条件分岐\",\"カスタムヘルパー登録（設定値呼び出し）\"]},{\"identifier\":\"ejs.render() (L271)\",\"security_function\":\"EJSテンプレートのレンダリング\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"ユーザー入力テンプレート直接受け取り\",\"<% %>内でJavaScript実行\",\"サンドボックス化なし\"],\"bypass_vectors\":[\"<% process.exit(1) %>\",\"<% require('child_process').exec('cmd') %>\",\"require()経由での任意モジュール読み込み\"]},{\"identifier\":\"eval(`(${serialized})`) (L428)\",\"security_function\":\"シリアライズされたデータの逆シリアライズ\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"eval()使用（最も危険）\",\"入力検証なし\",\"サンドボックス化なし\"],\"bypass_vectors\":[\"任意JavaScript コード実行\",\"RCE直結\"]}],\"resources\":[{\"identifier\":\"users テーブル\",\"sensitivity_level\":\"critical\",\"operation_type\":\"SQL SELECT/INSERT/UPDATE\",\"protection_mechanisms\":[\"なし（SQLインジェクション対策なし）\"]},{\"identifier\":\"audit_logs テーブル\",\"sensitivity_level\":\"high\",\"operation_type\":\"SQL INSERT\",\"protection_mechanisms\":[\"なし（SQLインジェクション対策、ユーザー認証確認なし）\"]},{\"identifier\":\"comments テーブル\",\"sensitivity_level\":\"high\",\"operation_type\":\"SQL INSERT/SELECT\",\"protection_mechanisms\":[\"なし（SQLインジェクション、ストアドXSS対策なし）\"]},{\"identifier\":\"documents テーブル\",\"sensitivity_level\":\"high\",\"operation_type\":\"SQL SELECT\",\"protection_mechanisms\":[\"なし（SQLインジェクション、認可チェックなし）\"]},{\"identifier\":\"ファイルシステム\",\"sensitivity_level\":\"critical\",\"operation_type\":\"fs.readFileSync(), fs.readdirSync(), fs.renameSync()\",\"protection_mechanisms\":[\"なし（パストラバーサル対策なし、ホワイトリストなし）\"]},{\"identifier\":\"システムコマンド実行\",\"sensitivity_level\":\"critical\",\"operation_type\":\"execSync()\",\"protection_mechanisms\":[\"なし（コマンドインジェクション対策なし）\"]},{\"identifier\":\"外部ネットワーク\",\"sensitivity_level\":\"high\",\"operation_type\":\"axios.get()\",\"protection_mechanisms\":[\"タイムアウト設定あり（5000ms）のみ\"]},{\"identifier\":\"テンプレートエンジン\",\"sensitivity_level\":\"critical\",\"operation_type\":\"handlebars.compile(), ejs.render()\",\"protection_mechanisms\":[\"なし（テンプレートインジェクション対策なし）\"]},{\"identifier\":\"JavaScriptランタイム\",\"sensitivity_level\":\"critical\",\"operation_type\":\"eval()\",\"protection_mechanisms\":[\"なし（eval()使用 - 最も危険）\"]}],\"policy_violations\":[{\"rule_id\":\"JWT-001\",\"rule_description\":\"JWTシークレットキーは十分なエントロピーを持つランダム値であるべき\",\"violation_path\":\"Principal(req.body.username/password) -> Action(jwt.sign L61-65) -> Resource(JWT_SECRET 'super_secret_js_key_123') -> jwt.verify()\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"JWT-002\",\"rule_description\":\"JWTトークンには有効期限(expiresIn)を設定すべき\",\"violation_path\":\"Principal(req.body.token) -> Action(jwt.sign L61, jwt.verify L88) -> Resource(トークン有効期限)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"JWT-003\",\"rule_description\":\"JWT検証後、トークンの役割・権限に基づく認可チェックが必須\",\"violation_path\":\"Principal(req.body.token with role) -> Action(jwt.verify L88) -> Resource(管理者操作)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"SQLI-001\",\"rule_description\":\"ユーザー入力をSQLクエリに直接挿入してはいけない（パラメータ化クエリを使用）\",\"violation_path\":\"Principal(req.body.username) -> Action(文字列補間 L47) -> Resource(SQLクエリ、users テーブル)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SQLI-002\",\"rule_description\":\"ユーザー入力をSQLクエリに直接挿入してはいけない（パラメータ化クエリを使用）\",\"violation_path\":\"Principal(req.query.q/role/limit) -> Action(文字列補間 L122, L126, L130) -> Resource(SQLクエリ、users テーブル)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SQLI-003\",\"rule_description\":\"ユーザー入力をSQLクエリに直接挿入してはいけない（パラメータ化クエリを使用）\",\"violation_path\":\"Principal(req.body.content/author) -> Action(文字列補間 L469) -> Resource(SQLクエリ、comments テーブル)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"RCE-001\",\"rule_description\":\"ユーザー入力をシステムコマンドに渡してはいけない（ホワイトリスト検証またはコマンド禁止）\",\"violation_path\":\"Principal(req.body.command/args) -> Action(execSync L324) -> Resource(システムコマンド実行)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"LFI-001\",\"rule_description\":\"ユーザー入力ファイルパスはホワイトリスト検証またはパストラバーサル対策が必須\",\"violation_path\":\"Principal(req.query.path) -> Action(パス検証なし) -> Resource(fs.readFileSync L344)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SSRF-001\",\"rule_description\":\"ユーザー指定URLへのアクセスはホワイトリスト・スキーム制限が必須\",\"violation_path\":\"Principal(req.body.url) -> Action(URLバリデーション欠落 L199) -> Resource(axios.get 外部ネットワーク)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"IDOR-001\",\"rule_description\":\"リソースアクセスにはユーザーIDの検証・認可チェックが必須\",\"violation_path\":\"Principal(req.params.id) -> Action(認可チェックなし) -> Resource(任意ユーザーのデータ /user/:id)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"IDOR-002\",\"rule_description\":\"リソースアクセスにはユーザーIDの検証・認可チェックが必須\",\"violation_path\":\"Principal(req.params.user_id) -> Action(認可チェックなし) -> Resource(任意ユーザーの監査ログ /logs/:user_id)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"TPLINJECTION-001\",\"rule_description\":\"ユーザー入力テンプレートをコンパイル・レンダリングしてはいけない\",\"violation_path\":\"Principal(req.body.template) -> Action(handlebars.compile L257) -> Resource(テンプレートエンジン)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"TPLINJECTION-002\",\"rule_description\":\"ユーザー入力テンプレートをコンパイル・レンダリングしてはいけない\",\"violation_path\":\"Principal(req.body.template) -> Action(ejs.render L271) -> Resource(テンプレートエンジン)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"DESER-001\",\"rule_description\":\"ユーザー入力をeval()で実行してはいけない（最も危険）\",\"violation_path\":\"Principal(req.body.serialized) -> Action(eval L428) -> Resource(JavaScriptランタイム)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"XSS-001\",\"rule_description\":\"DBに保存する前にユーザー入力をエスケープ・検証すべき（ストアドXSS対策）\",\"violation_path\":\"Principal(req.body.content) -> Action(検証なし L469) -> Resource(comments テーブル) -> GET /comments (表示)\",\"severity\":\"medium\",\"confidence\":1.0}]},\"remediation_guidance\":{\"policy_enforcement\":[{\"component\":\"JWT シークレットキー（L30）\",\"required_improvement\":\"強力でランダムなシークレットキーに変更\",\"specific_guidance\":\"const JWT_SECRET = crypto.randomBytes(32).toString('hex'); または環境変数から読み込む\\nMin 256ビットのランダムキーを使用（crypto.randomBytes(32)推奨）\",\"priority\":\"critical\"},{\"component\":\"JWT 署名（L61-65）\",\"required_improvement\":\"トークン有効期限を設定\",\"specific_guidance\":\"jwt.sign({ user_id, username, role }, JWT_SECRET, { algorithm: 'HS256', expiresIn: '1h' });\\nまたはrefresh token パターンを実装\",\"priority\":\"high\"},{\"component\":\"JWT 検証（L88）\",\"required_improvement\":\"検証後に役割ベースのアクセス制御(RBAC)を実装\",\"specific_guidance\":\"jwt.verify後、トークンのroleをチェック。管理者操作は role === 'admin' のみ許可\\nミドルウェアで認可チェックを一元化\",\"priority\":\"high\"},{\"component\":\"SQL クエリ（L47, L122, L126, L130, L150, L469, 他複数）\",\"required_improvement\":\"パラメータ化クエリ（プリペアドステートメント）を使用\",\"specific_guidance\":\"db.get('SELECT * FROM users WHERE username = ? AND password = ?', [username, password], callback)\\nsqlite3では?プレースホルダー、またはdb.prepare()を使用\",\"priority\":\"critical\"},{\"component\":\"ファイル読み取り（L179, L344）\",\"required_improvement\":\"パストラバーサル対策とホワイトリスト検証\",\"specific_guidance\":\"const path = require('path');\\nconst allowedDir = '/var/documents';\\nconst fullPath = path.resolve(allowedDir, filePath);\\nif (!fullPath.startsWith(allowedDir)) return res.status(403).json({ error: 'Access denied' });\\nfs.readFileSync(fullPath);\",\"priority\":\"critical\"},{\"component\":\"コマンド実行（L324）\",\"required_improvement\":\"ホワイトリスト方式またはコマンド禁止\",\"specific_guidance\":\"コマンドインジェクションが可能なため、execSync()ではなく特定のツールに限定。\\n例: allowedCommands = ['ls', 'pwd']; \\nif (!allowedCommands.includes(command)) return res.status(403).json({ error: 'Command not allowed' });\\n最善は子プロセスで配列引数を使用: require('child_process').execFile(cmd, args)\",\"priority\":\"critical\"},{\"component\":\"外部URL取得（L199, L216）\",\"required_improvement\":\"URLホワイトリスト・スキーム制限\",\"specific_guidance\":\"const url = new URL(requestUrl);\\nconst whitelist = ['https://trusted-domain.com'];\\nif (!whitelist.some(domain => url.hostname === domain)) return res.status(403).json({ error: 'URL not whitelisted' });\\nif (!['http:', 'https:'].includes(url.protocol)) return res.status(403).json({ error: 'Invalid protocol' });\",\"priority\":\"high\"},{\"component\":\"テンプレート（L252-264, L266-277）\",\"required_improvement\":\"ユーザー入力テンプレート受け取り禁止\",\"specific_guidance\":\"テンプレートを静的なファイルから読み込み、ユーザー入力はデータ部分のみ許可\\nもしユーザーテンプレートが必要な場合、サンドボックス化ライブラリ（worker threads等）を使用\",\"priority\":\"critical\"},{\"component\":\"eval()（L428）\",\"required_improvement\":\"eval()を完全に削除\",\"specific_guidance\":\"eval()は使用禁止。\\nJSON.parse()を使用するか、JSON.stringify()でシリアライズ\\nまたはNode-VMなどのサンドボックス環境を使用（ただしオーバーヘッドあり）\",\"priority\":\"critical\"},{\"component\":\"認可チェック（L96-113, L449-462）\",\"required_improvement\":\"ユーザー認証・認可ミドルウェアを実装\",\"specific_guidance\":\"router.get('/user/:id', authenticateUser, authorizeUser, (req, res) => {\\n  if (req.user.id !== parseInt(req.params.id) && req.user.role !== 'admin') {\\n    return res.status(403).json({ error: 'Unauthorized' });\\n  }\\n  // 処理\\n});\",\"priority\":\"high\"},{\"component\":\"ストアドXSS（L469, L483）\",\"required_improvement\":\"入力検証・エスケープ\",\"specific_guidance\":\"DB保存時：parameterized queryで SQLインジェクション防止\\n表示時：レスポンスのContent-Type: application/jsonで自動エスケープ\\nまたはHTMLエスケープ関数: const escape = (str) => str.replace(/[&<>\\\"']/g, c => ({'&': '&amp;', '<': '&lt;', '>': '&gt;', '\\\"': '&quot;', \\\"'\\\": '&#39;'}[c]));\",\"priority\":\"medium\"},{\"component\":\"YAML パース（L436-446）\",\"required_improvement\":\"yaml.load()の引数確認またはJSON使用\",\"specific_guidance\":\"YAML デシリアライゼーション攻撃の可能性あり。\\nできればJSONに変更。どうしてもYAMLの場合、yaml.parse()（JSON-safe）を使用。\\nYAMLライブラリのバージョン確認：yaml.load()はサンドボックス設定が必要\",\"priority\":\"high\"},{\"component\":\"ログに平文パスワード出力（L49）\",\"required_improvement\":\"パスワードはログに出力しない\",\"specific_guidance\":\"logger.info(`API login attempt: ${username}`, { username, ip: req.ip }); // パスワード除外\\nまたはhash化: const hash = require('crypto').createHash('sha256').update(password).digest('hex');\",\"priority\":\"high\"},{\"component\":\"エラーメッセージにクエリを含める（L55, L137）\",\"required_improvement\":\"本番環境ではクエリ内容を非表示にする\",\"specific_guidance\":\"if (process.env.NODE_ENV === 'production') {\\n  res.status(500).json({ error: 'Database error' });\\n} else {\\n  res.status(500).json({ error: err.message, query });\\n}\",\"priority\":\"medium\"},{\"component\":\"ファイルアップロード（L366-385）\",\"required_improvement\":\"ファイル名検証・拡張子制限\",\"specific_guidance\":\"const allowedExtensions = ['.pdf', '.doc', '.txt'];\\nconst ext = path.extname(req.file.originalname).toLowerCase();\\nif (!allowedExtensions.includes(ext)) return res.status(400).json({ error: 'File type not allowed' });\\nファイル名をランダム化：const newName = crypto.randomBytes(16).toString('hex') + ext;\",\"priority\":\"high\"},{\"component\":\"archive 抽出（L396）\",\"required_improvement\":\"zip bomb・path traversal 対策\",\"specific_guidance\":\"抽出前にファイルサイズとファイル数チェック\\nextract() 後、抽出パスがextractDir配下か検証\\n const files = fs.readdirSync(extractDir);\\nfiles.forEach(file => {\\n  const fullPath = path.resolve(extractDir, file);\\n  if (!fullPath.startsWith(extractDir)) throw new Error('Path traversal detected');\\n});\",\"priority\":\"high\"}]},\"file_path\":null,\"pattern_description\":null,\"matched_source_code\":null}",
  "metadata": {
    "created_at": "2025-12-30T16:38:30.922477Z",
    "last_accessed": "2025-12-30T16:38:30.922477Z",
    "access_count": 0,
    "prompt_size": 19873,
    "response_size": 25069
  }
}