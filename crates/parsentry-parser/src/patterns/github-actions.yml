# GitHub Actions and YAML Security Patterns (PAR Framework)
# Focus: CI/CD Pipeline Security, Supply Chain Attacks, Credential Exposure

principals:
  # Event triggers that accept external input
  - reference: |
      (block_mapping_pair
        (flow_node
          (plain_scalar
            (string_scalar) @trigger
            (#eq? @trigger "pull_request_target"))))
    description: "pull_request_target trigger (dangerous with external input)"
    attack_vector:
      - "T1134"  # Access Token Manipulation
      - "T1068"  # Exploitation for Privilege Escalation

  - reference: |
      (block_mapping_pair
        (flow_node
          (plain_scalar
            (string_scalar) @trigger
            (#eq? @trigger "issue_comment"))))
    description: "Issue comment trigger with external input"
    attack_vector:
      - "T1134"  # Access Token Manipulation
      - "T1055"  # Process Injection

  - reference: |
      (block_mapping_pair
        (flow_node
          (plain_scalar
            (string_scalar) @trigger
            (#eq? @trigger "workflow_run"))))
    description: "workflow_run trigger (can execute with untrusted code)"
    attack_vector:
      - "T1134"  # Access Token Manipulation
      - "T1068"  # Exploitation for Privilege Escalation

  # Self-hosted runners (potential compromise vector)
  - reference: |
      (flow_sequence
        (flow_node
          (plain_scalar
            (string_scalar) @runner
            (#eq? @runner "self-hosted"))))
    description: "Self-hosted runner usage"
    attack_vector:
      - "T1609"  # Container Administration Command
      - "T1611"  # Escape to Host

actions:
  # Credential and secret exposure
  - reference: |
      (string_scalar) @secret
      (#match? @secret "\\$\\{\\{.*secrets\\.")
    description: "Direct secret usage in workflow"
    attack_vector:
      - "T1552.001"  # Unsecured Credentials: Credentials In Files
      - "T1078"       # Valid Accounts

  # Environment variable injection
  - reference: |
      (string_scalar) @event
      (#match? @event "\\$\\{\\{.*github\\.event\\.")
    description: "Direct GitHub event data usage (injection risk)"
    attack_vector:
      - "T1059"  # Command and Scripting Interpreter
      - "T1055"  # Process Injection

resources:
  # Sensitive credentials - single consolidated pattern
  - reference: |
      (string_scalar) @credential
      (#match? @credential "AWS_ACCESS_KEY|DEPLOY_TOKEN|DOCKER|NPM_TOKEN|GITHUB_TOKEN")
    description: "Sensitive credentials detected in workflow"
    attack_vector:
      - "T1552"  # Unsecured Credentials
      - "T1078"  # Valid Accounts